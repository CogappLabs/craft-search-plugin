{% do view.registerAssetBundle("cogapp\\searchindex\\web\\assets\\searchdocumentfield\\SearchDocumentFieldAsset") %}

{% set fieldId = 'search-doc-' ~ field.handle ~ '-' ~ (random()) %}
{% set listboxId = fieldId ~ '-listbox' %}

{# Build display title server-side (no "Loading..." flash) #}
{% if documentId and documentTitle %}
    {% set meta = [sectionHandle ?? '', entryTypeHandle ?? '']|filter|join(' / ') %}
    {% set displayTitle = documentTitle|e %}
    {% if meta %}{% set displayTitle = displayTitle ~ ' <span class="light">&mdash; ' ~ meta|e ~ '</span>' %}{% endif %}
    {% if documentUri %}{% set displayTitle = displayTitle ~ ' <span class="light">&mdash; ' ~ documentUri|e ~ '</span>' %}{% endif %}
    {% set displayTitle = displayTitle ~ ' <span class="light">(ID: ' ~ documentId|e ~ ')</span>' %}
{% endif %}

<div id="{{ fieldId }}" class="search-document-field" data-field-id="{{ fieldId }}" data-per-page="{{ perPage }}"
    data-t-search-failed="{{ 'Search failed.'|t('search-index') }}"
    data-t-no-results="{{ 'No results found.'|t('search-index') }}"
>
    <input type="hidden" name="{{ field.handle }}[indexHandle]" value="{{ indexHandle }}" class="sdf-index-handle">
    <input type="hidden" name="{{ field.handle }}[documentId]" value="{{ documentId }}" class="sdf-document-id">
    <input type="hidden" name="{{ field.handle }}[sectionHandle]" value="{{ sectionHandle ?? '' }}" class="sdf-section-handle">
    <input type="hidden" name="{{ field.handle }}[entryTypeHandle]" value="{{ entryTypeHandle ?? '' }}" class="sdf-entry-type-handle">

    {# Selected document display #}
    <div class="sdf-selected{{ not documentId ? ' hidden' : '' }}">
        <div class="flex flex-nowrap">
            <div class="sdf-selected-info flex-grow">
                <span class="sdf-selected-title">{% if displayTitle is defined %}{{ displayTitle|raw }}{% endif %}</span>
            </div>
            <button type="button" class="btn small sdf-clear" title="{{ 'Clear selection'|t('search-index') }}">
                <span data-icon="remove"></span>
            </button>
        </div>
    </div>

    {# Search input #}
    <div class="sdf-search{{ documentId ? ' hidden' : '' }}">
        <div class="text">
            <input type="text"
                   class="text fullwidth sdf-query"
                   placeholder="{{ 'Search {handle}â€¦'|t('search-index', { handle: indexHandle }) }}"
                   autocomplete="off"
                   role="combobox"
                   aria-expanded="false"
                   aria-autocomplete="list"
                   aria-controls="{{ listboxId }}">
        </div>
        <div class="sdf-results hidden" aria-live="polite">
            <ul class="sdf-results-list" id="{{ listboxId }}" role="listbox"></ul>
        </div>
    </div>
</div>
