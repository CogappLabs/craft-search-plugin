{# Sprig component: compare search across multiple indexes. #}
{# Variables: indexOptions (array) #}

{% import "_includes/forms" as forms %}

{% set query = query ?? '' %}
{% set perPage = perPage ?? 20 %}
{% set compareIndexes = compareIndexes ?? [] %}
{% set _doSearch = _doSearch ?? false %}

<div class="mb-m">
    {{ forms.checkboxSelectField({
        label: 'Indexes to compare'|t('search-index'),
        id: 'compare-indexes',
        name: 'compareIndexes',
        values: compareIndexes,
        options: indexOptions,
    }) }}
</div>

<div class="flex mb-m si-search-bar">
    <div class="flex-grow">
        <div class="field">
            <div class="heading"><label for="compare-query">{{ 'Query'|t('search-index') }}</label></div>
            <div class="input">
                <input sprig type="text" id="compare-query" name="query" value="{{ query }}" class="text fullwidth"
                    placeholder="{{ 'Searchâ€¦'|t('search-index') }}"
                    s-trigger="keyup[key=='Enter']"
                    s-val:_do-search="1"
                    s-include="#compare-indexes,#compare-perpage"
                >
            </div>
        </div>
    </div>
    <div class="si-perpage-field">
        <div class="field">
            <div class="heading"><label for="compare-perpage">{{ 'Per Page'|t('search-index') }}</label></div>
            <div class="input">
                <input type="number" id="compare-perpage" name="perPage" value="{{ perPage }}" class="text" min="1" max="100" size="5">
            </div>
        </div>
    </div>
    <div>
        <div class="field">
            <div class="heading"><label>&nbsp;</label></div>
            <div class="input">
                <button sprig type="button" class="btn submit"
                    s-val:_do-search="1"
                    s-include="#compare-indexes,#compare-query,#compare-perpage"
                >{{ "Search All"|t('search-index') }}</button>
            </div>
        </div>
    </div>
</div>

{# Results #}
{% if _doSearch %}
    {% if compareIndexes|length == 0 %}
        <p class="error">{{ 'Select at least one index to compare.'|t('search-index') }}</p>
    {% elseif not query|trim %}
        <p class="error">{{ 'Please enter a search query.'|t('search-index') }}</p>
    {% else %}
        <div class="flex si-compare-results">
            {% for handle in compareIndexes %}
                <div class="si-compare-panel">
                    <h3>{{ handle }}</h3>
                    {% set data = craft.searchIndex.cpSearch(handle, query, { perPage: perPage }) %}

                    {% if not data.success %}
                        <p class="error">{{ data.message }}</p>
                    {% else %}
                        <p class="light mb-xs">
                            {{ '{total} results in {time}ms'|t('search-index', {
                                total: data.totalHits,
                                time: data.processingTimeMs,
                            }) }}
                        </p>

                        {% if not data.hits or data.hits|length == 0 %}
                            <p class="zilch">{{ 'No results.'|t('search-index') }}</p>
                        {% else %}
                            <table class="data fullwidth">
                                <thead>
                                    <tr>
                                        <th>{{ 'Title'|t('search-index') }}</th>
                                        <th>{{ 'Score'|t('search-index') }}</th>
                                        <th>{{ 'ID'|t('search-index') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for hit in data.hits %}
                                        <tr>
                                            <td>{{ hit.title ?? hit.name ?? '-' }}</td>
                                            <td>{{ hit._score is defined and hit._score is not null ? hit._score : '-' }}</td>
                                            <td><code>{{ hit.objectID ?? '-' }}</code></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}

                        {% if data.raw %}
                            <details class="mt-xs">
                                <summary>{{ 'Raw engine response'|t('search-index') }}</summary>
                                <pre class="code si-code-block si-raw-json">{{ data.raw|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_SLASHES')) }}</pre>
                            </details>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endif %}
