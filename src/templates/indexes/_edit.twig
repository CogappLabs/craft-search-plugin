{% import "_includes/forms" as forms %}

{% do view.registerAssetBundle("cogapp\\searchindex\\web\\assets\\indexedit\\IndexEditAsset") %}

{% if not isNew %}
    {{ hiddenInput('indexId', index.id) }}
{% endif %}

{{ forms.textField({
    label: "Name"|t('search-index'),
    id: 'name',
    name: 'name',
    value: index.name,
    required: true,
    errors: index.getErrors('name'),
    autofocus: true,
    disabled: not allowAdminChanges,
}) }}

{{ forms.textField({
    label: "Handle"|t('search-index'),
    id: 'handle',
    name: 'handle',
    value: index.handle,
    required: true,
    errors: index.getErrors('handle'),
    class: 'code',
    disabled: not allowAdminChanges,
}) }}

{% set engineOptions = [{label: 'Select an engineâ€¦'|t('search-index'), value: ''}] %}
{% for engine in engineTypes %}
    {% set engineOptions = engineOptions|merge([{
        label: engine.displayName,
        value: engine.class,
    }]) %}
{% endfor %}

{{ forms.selectField({
    label: "Engine"|t('search-index'),
    id: 'engineType',
    name: 'engineType',
    value: index.engineType,
    options: engineOptions,
    required: true,
    errors: index.getErrors('engineType'),
    disabled: not allowAdminChanges,
}) }}

<div id="engine-config">
    {% for engine in engineTypes %}
        <div class="engine-config-fields{{ index.engineType != engine.class ? ' hidden' : '' }}" data-engine="{{ engine.class }}">
            {% for handle, field in engine.configFields %}
                {{ forms.textField({
                    label: field.label,
                    id: 'engineConfig-' ~ handle,
                    name: 'engineConfig[' ~ handle ~ ']',
                    value: index.engineConfig[handle] ?? '',
                    instructions: (field.instructions ?? '') ~ ' Supports environment variables (e.g. $MY_VAR).',
                    class: 'code',
                    disabled: not allowAdminChanges,
                }) }}
            {% endfor %}
        </div>
    {% endfor %}
</div>

{% if not allowAdminChanges %}
    {# Hidden mirrors of disabled fields so test-connection Sprig can read them via s-include #}
    <div id="si-readonly-vals" class="hidden">
        <input type="hidden" name="engineType" value="{{ index.engineType }}">
        <input type="hidden" name="mode" value="{{ index.mode ?? 'synced' }}">
        <input type="hidden" name="handle" value="{{ index.handle }}">
        {% for cfgHandle, cfgValue in index.engineConfig %}
            <input type="hidden" name="engineConfig[{{ cfgHandle }}]" value="{{ cfgValue }}">
        {% endfor %}
    </div>
{% endif %}

<div id="test-connection" class="flex mt-s flex-center">
    {{ searchIndexSprig('cp.test-connection', { run: false }) }}
</div>

<hr>

{{ forms.selectField({
    label: "Mode"|t('search-index'),
    id: 'mode',
    name: 'mode',
    value: index.mode ?? 'synced',
    options: [
        { label: 'Synced'|t('search-index'), value: 'synced' },
        { label: 'Read-only'|t('search-index'), value: 'readonly' },
    ],
    instructions: "Synced indexes push Craft content to the engine. Read-only indexes are managed externally and only queried."|t('search-index'),
    disabled: not allowAdminChanges,
}) }}

<div id="synced-sources">

<h2>{{ "Sources"|t('search-index') }}</h2>

{{ forms.checkboxSelectField({
    label: "Sections"|t('search-index'),
    id: 'sectionIds',
    name: 'sectionIds',
    values: index.sectionIds ?? [],
    options: sectionOptions,
    instructions: "Select which sections feed this index."|t('search-index'),
    disabled: not allowAdminChanges,
}) }}

<div id="entry-type-fields">
    <div class="field">
        <div class="heading">
            <label>{{ "Entry Types"|t('search-index') }}</label>
            <div class="instructions"><p>{{ "Optionally limit to specific entry types."|t('search-index') }}</p></div>
        </div>
        <div class="input">
            {% for sectionId, types in entryTypeOptions %}
                {% for type in types %}
                    <div class="entry-type-checkbox{{ sectionId not in (index.sectionIds ?? []) ? ' hidden' : '' }}" data-section="{{ sectionId }}">
                        {{ forms.checkbox({
                            label: type.label,
                            name: 'entryTypeIds[]',
                            value: type.value,
                            checked: type.value in (index.entryTypeIds ?? []),
                            disabled: not allowAdminChanges,
                        }) }}
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<hr>

{{ forms.selectField({
    label: "Site"|t('search-index'),
    id: 'siteId',
    name: 'siteId',
    value: index.siteId ?? '',
    options: siteOptions,
    instructions: "Which site's content to index. Leave blank for the primary site."|t('search-index'),
    disabled: not allowAdminChanges,
}) }}

</div>{# /synced-sources #}

{% if not isNew %}
    <div id="si-toggle-enabled"
         data-index-id="{{ index.id }}"
         data-t-enabled-notice="{{ 'Index enabled.'|t('search-index') }}"
         data-t-disabled-notice="{{ 'Index disabled.'|t('search-index') }}"
         data-t-toggle-error="{{ 'Failed to update enabled state.'|t('search-index') }}"
    >
        {{ forms.lightswitchField({
            label: "Enabled"|t('search-index'),
            id: 'enabled',
            name: 'enabled',
            on: index.enabled,
        }) }}
    </div>
{% else %}
    {{ forms.lightswitchField({
        label: "Enabled"|t('search-index'),
        id: 'enabled',
        name: 'enabled',
        on: index.enabled,
    }) }}
{% endif %}
