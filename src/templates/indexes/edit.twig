{% extends "search-index/_layouts/plugin" %}
{% import "_includes/forms" as forms %}

{% set title = isNew ? "New Index" : "Edit Index: #{index.name}" %}
{% set selectedSubnavItem = 'indexes' %}

{% block content %}
    <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('search-index/indexes/save') }}
        {{ redirectInput('search-index/indexes/{id}') }}

        {% if not isNew %}
            {{ hiddenInput('indexId', index.id) }}
        {% endif %}

        {{ forms.textField({
            label: "Name"|t('search-index'),
            id: 'name',
            name: 'name',
            value: index.name,
            required: true,
            errors: index.getErrors('name'),
            autofocus: true,
        }) }}

        {{ forms.textField({
            label: "Handle"|t('search-index'),
            id: 'handle',
            name: 'handle',
            value: index.handle,
            required: true,
            errors: index.getErrors('handle'),
            class: 'code',
        }) }}

        {% set engineOptions = [{label: 'Select an engine...', value: ''}] %}
        {% for engine in engineTypes %}
            {% set engineOptions = engineOptions|merge([{
                label: engine.displayName,
                value: engine.class,
            }]) %}
        {% endfor %}

        {{ forms.selectField({
            label: "Engine"|t('search-index'),
            id: 'engineType',
            name: 'engineType',
            value: index.engineType,
            options: engineOptions,
            required: true,
            errors: index.getErrors('engineType'),
        }) }}

        <div id="engine-config">
            {% for engine in engineTypes %}
                <div class="engine-config-fields" data-engine="{{ engine.class }}" style="{{ index.engineType != engine.class ? 'display:none' : '' }}">
                    {% for handle, field in engine.configFields %}
                        {{ forms.textField({
                            label: field.label,
                            id: 'engineConfig-' ~ handle,
                            name: 'engineConfig[' ~ handle ~ ']',
                            value: index.engineConfig[handle] ?? '',
                            instructions: field.instructions ?? '',
                            class: field.type == 'password' ? 'code' : '',
                            type: field.type ?? 'text',
                        }) }}
                    {% endfor %}
                </div>
            {% endfor %}
        </div>

        <hr>

        <h2>Sources</h2>

        {{ forms.checkboxSelectField({
            label: "Sections"|t('search-index'),
            id: 'sectionIds',
            name: 'sectionIds',
            values: index.sectionIds ?? [],
            options: sectionOptions,
            instructions: "Select which sections feed this index.",
        }) }}

        <div id="entry-type-fields">
            <div class="field">
                <div class="heading">
                    <label>{{ "Entry Types"|t('search-index') }}</label>
                    <div class="instructions"><p>Optionally limit to specific entry types.</p></div>
                </div>
                <div class="input">
                    {% for sectionId, types in entryTypeOptions %}
                        {% for type in types %}
                            <div class="entry-type-checkbox" data-section="{{ sectionId }}" style="{{ sectionId not in (index.sectionIds ?? []) ? 'display:none' : '' }}">
                                {{ forms.checkbox({
                                    label: type.label,
                                    name: 'entryTypeIds[]',
                                    value: type.value,
                                    checked: type.value in (index.entryTypeIds ?? []),
                                }) }}
                            </div>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <hr>

        {% set siteOptions = [{label: 'Primary site', value: ''}] %}
        {% for site in craft.app.sites.getAllSites() %}
            {% set siteOptions = siteOptions|merge([{
                label: site.name,
                value: site.id,
            }]) %}
        {% endfor %}

        {{ forms.selectField({
            label: "Site"|t('search-index'),
            id: 'siteId',
            name: 'siteId',
            value: index.siteId ?? '',
            options: siteOptions,
            instructions: "Which site's content to index. Leave blank for the primary site.",
        }) }}

        {{ forms.lightswitchField({
            label: "Enabled"|t('search-index'),
            id: 'enabled',
            name: 'enabled',
            on: index.enabled,
        }) }}

        <div class="buttons">
            <button type="submit" class="btn submit">Save</button>
        </div>
    </form>
{% endblock %}

{% js %}
// Toggle engine config fields
document.getElementById('engineType').addEventListener('change', function() {
    document.querySelectorAll('.engine-config-fields').forEach(function(el) {
        el.style.display = 'none';
    });
    var selected = document.querySelector('.engine-config-fields[data-engine="' + this.value + '"]');
    if (selected) {
        selected.style.display = '';
    }
});

// Handle name -> handle auto-generation
var nameInput = document.getElementById('name');
var handleInput = document.getElementById('handle');
var handleManuallySet = {{ not isNew ? 'true' : 'false' }};

nameInput.addEventListener('input', function() {
    if (!handleManuallySet) {
        handleInput.value = this.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '_')
            .replace(/^_|_$/g, '');
    }
});

handleInput.addEventListener('input', function() {
    handleManuallySet = true;
});

// Toggle entry type checkboxes based on selected sections
document.querySelectorAll('#sectionIds input[type="checkbox"]').forEach(function(cb) {
    cb.addEventListener('change', function() {
        document.querySelectorAll('.entry-type-checkbox[data-section="' + this.value + '"]').forEach(function(el) {
            el.style.display = cb.checked ? '' : 'none';
        });
    });
});
{% endjs %}
