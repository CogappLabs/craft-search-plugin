{% extends "search-index/_layouts/plugin" %}

{% set title = "Search" %}
{% set selectedSubnavItem = 'search' %}

{% import "_includes/forms" as forms %}

{% block content %}
    <div id="search-page">
        {# Mode toggle #}
        <div class="btngroup" style="margin-bottom:24px">
            <button type="button" class="btn active" data-mode="single">Single</button>
            <button type="button" class="btn" data-mode="compare">Compare</button>
        </div>

        {# Single mode #}
        <div id="single-mode">
            <div class="flex" style="gap:12px;align-items:flex-end;margin-bottom:16px">
                <div style="min-width:220px">
                    {{ forms.selectField({
                        label: 'Index',
                        id: 'single-index',
                        options: indexOptions,
                        first: true,
                    }) }}
                </div>
                <div class="flex-grow">
                    {{ forms.textField({
                        label: 'Query',
                        id: 'single-query',
                        placeholder: 'Search…',
                    }) }}
                </div>
                <div style="min-width:80px">
                    {{ forms.textField({
                        label: 'Per Page',
                        id: 'single-perpage',
                        value: 20,
                        type: 'number',
                        min: 1,
                        max: 100,
                        size: 5,
                    }) }}
                </div>
                <div>
                    <button type="button" id="single-search-btn" class="btn submit">Search</button>
                </div>
            </div>

            <div id="single-results"></div>
        </div>

        {# Compare mode #}
        <div id="compare-mode" style="display:none">
            <div style="margin-bottom:16px">
                <label class="heading" style="display:block;margin-bottom:8px">Indexes to compare</label>
                <div id="compare-indexes" style="margin-bottom:12px">
                    {% for opt in indexOptions %}
                        <label style="display:inline-block;margin-right:16px;margin-bottom:4px">
                            <input type="checkbox" class="compare-index-cb" value="{{ opt.value }}"> {{ opt.label }}
                        </label>
                    {% endfor %}
                </div>
            </div>

            <div class="flex" style="gap:12px;align-items:flex-end;margin-bottom:16px">
                <div class="flex-grow">
                    {{ forms.textField({
                        label: 'Query',
                        id: 'compare-query',
                        placeholder: 'Search…',
                    }) }}
                </div>
                <div style="min-width:80px">
                    {{ forms.textField({
                        label: 'Per Page',
                        id: 'compare-perpage',
                        value: 20,
                        type: 'number',
                        min: 1,
                        max: 100,
                        size: 5,
                    }) }}
                </div>
                <div>
                    <button type="button" id="compare-search-btn" class="btn submit">Search All</button>
                </div>
            </div>

            <div id="compare-results" class="flex" style="gap:16px;flex-wrap:wrap"></div>
        </div>
    </div>
{% endblock %}

{% js %}
(function() {
    // Mode toggle
    var modeButtons = document.querySelectorAll('#search-page .btngroup .btn');
    var singleMode = document.getElementById('single-mode');
    var compareMode = document.getElementById('compare-mode');

    modeButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
            modeButtons.forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            if (this.dataset.mode === 'single') {
                singleMode.style.display = '';
                compareMode.style.display = 'none';
            } else {
                singleMode.style.display = 'none';
                compareMode.style.display = '';
            }
        });
    });

    // Single mode search
    var singleBtn = document.getElementById('single-search-btn');
    singleBtn.addEventListener('click', function() {
        var indexHandle = document.getElementById('single-index').value;
        var query = document.getElementById('single-query').value.trim();
        var perPage = parseInt(document.getElementById('single-perpage').value) || 20;

        if (!query) {
            Craft.cp.displayError('Please enter a search query.');
            return;
        }

        singleBtn.classList.add('loading');

        Craft.sendActionRequest('POST', 'search-index/search/search', {
            data: { indexHandle: indexHandle, query: query, perPage: perPage }
        }).then(function(response) {
            singleBtn.classList.remove('loading');
            renderSingleResults(response.data);
        }).catch(function(error) {
            singleBtn.classList.remove('loading');
            Craft.cp.displayError('Search failed.');
        });
    });

    // Allow Enter key on single query
    document.getElementById('single-query').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            singleBtn.click();
        }
    });

    function renderSingleResults(data) {
        var container = document.getElementById('single-results');

        if (!data.success) {
            container.innerHTML = '<p class="error">' + Craft.escapeHtml(data.message || 'Search failed.') + '</p>';
            return;
        }

        if (!data.hits || data.hits.length === 0) {
            container.innerHTML = '<p class="zilch">No results found.</p>';
            return;
        }

        var html = '<p class="light" style="margin-bottom:8px">' +
            data.totalHits + ' results in ' + data.processingTimeMs + 'ms ' +
            '(page ' + data.page + ' of ' + data.totalPages + ')</p>';

        html += '<table class="data fullwidth"><thead><tr>' +
            '<th>Title</th><th>URI</th><th>Score</th><th>Object ID</th><th></th>' +
            '</tr></thead><tbody>';

        data.hits.forEach(function(hit, i) {
            var title = hit.title || hit.name || '-';
            var uri = hit.uri || '-';
            var score = hit._score !== null && hit._score !== undefined ? hit._score : '-';
            var objectID = hit.objectID || '-';

            html += '<tr>' +
                '<td>' + Craft.escapeHtml(title) + '</td>' +
                '<td>' + Craft.escapeHtml(uri) + '</td>' +
                '<td>' + Craft.escapeHtml(String(score)) + '</td>' +
                '<td><code>' + Craft.escapeHtml(objectID) + '</code></td>' +
                '<td class="thin"><button type="button" class="btn small toggle-raw" data-index="' + i + '">JSON</button></td>' +
                '</tr>' +
                '<tr class="raw-row" data-index="' + i + '" style="display:none">' +
                '<td colspan="5"><pre style="max-height:200px;overflow:auto;font-size:12px;background:var(--gray-050);padding:8px;border-radius:4px">' +
                Craft.escapeHtml(JSON.stringify(hit, null, 2)) + '</pre></td></tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;

        // Toggle raw JSON rows
        container.querySelectorAll('.toggle-raw').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var idx = this.dataset.index;
                var row = container.querySelector('.raw-row[data-index="' + idx + '"]');
                if (row) {
                    row.style.display = row.style.display === 'none' ? '' : 'none';
                }
            });
        });
    }

    // Compare mode search
    var compareBtn = document.getElementById('compare-search-btn');
    compareBtn.addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.compare-index-cb:checked');
        var query = document.getElementById('compare-query').value.trim();
        var perPage = parseInt(document.getElementById('compare-perpage').value) || 20;

        if (checkboxes.length === 0) {
            Craft.cp.displayError('Select at least one index to compare.');
            return;
        }
        if (!query) {
            Craft.cp.displayError('Please enter a search query.');
            return;
        }

        compareBtn.classList.add('loading');
        var resultsContainer = document.getElementById('compare-results');
        resultsContainer.innerHTML = '';

        var pending = checkboxes.length;

        checkboxes.forEach(function(cb) {
            var indexHandle = cb.value;
            var panel = document.createElement('div');
            panel.style.cssText = 'flex:1;min-width:300px;max-width:50%';
            panel.innerHTML = '<h3>' + Craft.escapeHtml(indexHandle) + '</h3><p class="spinner"></p>';
            resultsContainer.appendChild(panel);

            Craft.sendActionRequest('POST', 'search-index/search/search', {
                data: { indexHandle: indexHandle, query: query, perPage: perPage }
            }).then(function(response) {
                renderComparePanel(panel, indexHandle, response.data);
                pending--;
                if (pending === 0) compareBtn.classList.remove('loading');
            }).catch(function() {
                panel.innerHTML = '<h3>' + Craft.escapeHtml(indexHandle) + '</h3>' +
                    '<p class="error">Search failed.</p>';
                pending--;
                if (pending === 0) compareBtn.classList.remove('loading');
            });
        });
    });

    // Allow Enter key on compare query
    document.getElementById('compare-query').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            compareBtn.click();
        }
    });

    function renderComparePanel(panel, indexHandle, data) {
        if (!data.success) {
            panel.innerHTML = '<h3>' + Craft.escapeHtml(indexHandle) + '</h3>' +
                '<p class="error">' + Craft.escapeHtml(data.message || 'Failed.') + '</p>';
            return;
        }

        var html = '<h3>' + Craft.escapeHtml(indexHandle) + '</h3>' +
            '<p class="light" style="margin-bottom:4px">' +
            data.totalHits + ' results in ' + data.processingTimeMs + 'ms</p>';

        if (!data.hits || data.hits.length === 0) {
            html += '<p class="zilch">No results.</p>';
        } else {
            html += '<table class="data fullwidth"><thead><tr>' +
                '<th>Title</th><th>Score</th><th>ID</th>' +
                '</tr></thead><tbody>';

            data.hits.forEach(function(hit) {
                var title = hit.title || hit.name || '-';
                var score = hit._score !== null && hit._score !== undefined ? hit._score : '-';
                html += '<tr><td>' + Craft.escapeHtml(title) + '</td>' +
                    '<td>' + Craft.escapeHtml(String(score)) + '</td>' +
                    '<td><code>' + Craft.escapeHtml(hit.objectID || '-') + '</code></td></tr>';
            });

            html += '</tbody></table>';
        }

        panel.innerHTML = html;
    }
})();
{% endjs %}
