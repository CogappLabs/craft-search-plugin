{% extends "search-index/_layouts/plugin" %}
{% import "_includes/forms" as forms %}

{% set title = "Search Index Settings"|t('search-index') %}
{% set selectedSubnavItem = 'settings' %}

{# Determine which engines are enabled (empty = all for backward compat) #}
{% set enabledEngines = settings.enabledEngines ?? [] %}

{% block content %}
    {% css %}
        .si-engine-section { margin-top: 24px; padding: 0; border: none; }
        .si-engine-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .si-engine-header h3 { margin: 0; }
    {% endcss %}

    {# ── Form 1: Engine Connections (always editable, saved to DB) ── #}
    <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('search-index/indexes/save-engine-settings') }}
        {{ redirectInput('search-index/settings') }}

        <h2>{{ "Engine Connections"|t('search-index') }}</h2>

        <p class="light">{{ "Engine credentials are stored per-environment and can be changed regardless of admin settings."|t('search-index') }}</p>

        {% for engine in engineInfo %}
            {% set engineKey = engine.class|replace({'\\': '_'}) %}

            <fieldset class="si-engine-section">
                <div class="si-engine-header">
                    <h3>{{ engine.displayName }}</h3>
                    {% if not engine.installed %}
                        <span class="status off" title="{{ 'Client library not installed'|t('search-index') }}"></span>
                    {% endif %}
                </div>

                {% if not engine.installed %}
                    <p class="warning with-icon">{{ ("Client library not installed. Run:")|t('search-index') }} <code>composer require {{ engine.package }}</code></p>
                {% endif %}

                {% if engine.displayName == 'Algolia' %}
                    {{ forms.autosuggestField({
                        label: "App ID"|t('search-index'),
                        id: 'algoliaAppId',
                        name: 'engineSettings[algoliaAppId]',
                        suggestEnvVars: true,
                        value: effectiveSettings.algoliaAppId,
                        instructions: "Your Algolia Application ID."|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "Admin API Key"|t('search-index'),
                        id: 'algoliaApiKey',
                        name: 'engineSettings[algoliaApiKey]',
                        suggestEnvVars: true,
                        value: effectiveSettings.algoliaApiKey,
                        instructions: "Your Algolia Admin API Key (used for indexing)."|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "Search API Key"|t('search-index'),
                        id: 'algoliaSearchApiKey',
                        name: 'engineSettings[algoliaSearchApiKey]',
                        suggestEnvVars: true,
                        value: effectiveSettings.algoliaSearchApiKey,
                        instructions: "Your Algolia Search-Only API Key (used for front-end search)."|t('search-index'),
                    }) }}

                {% elseif engine.displayName == 'Elasticsearch' %}
                    {{ forms.autosuggestField({
                        label: "Host"|t('search-index'),
                        id: 'elasticsearchHost',
                        name: 'engineSettings[elasticsearchHost]',
                        suggestEnvVars: true,
                        value: effectiveSettings.elasticsearchHost,
                        instructions: "Elasticsearch host URL (e.g., https://localhost:9200)."|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "Username"|t('search-index'),
                        id: 'elasticsearchUsername',
                        name: 'engineSettings[elasticsearchUsername]',
                        suggestEnvVars: true,
                        value: effectiveSettings.elasticsearchUsername,
                    }) }}

                    {{ forms.autosuggestField({
                        label: "Password"|t('search-index'),
                        id: 'elasticsearchPassword',
                        name: 'engineSettings[elasticsearchPassword]',
                        suggestEnvVars: true,
                        value: effectiveSettings.elasticsearchPassword,
                    }) }}

                    {{ forms.autosuggestField({
                        label: "API Key"|t('search-index'),
                        id: 'elasticsearchApiKey',
                        name: 'engineSettings[elasticsearchApiKey]',
                        suggestEnvVars: true,
                        value: effectiveSettings.elasticsearchApiKey,
                        instructions: "Alternative to username/password authentication."|t('search-index'),
                    }) }}

                {% elseif engine.displayName == 'Meilisearch' %}
                    {{ forms.autosuggestField({
                        label: "Host"|t('search-index'),
                        id: 'meilisearchHost',
                        name: 'engineSettings[meilisearchHost]',
                        suggestEnvVars: true,
                        value: effectiveSettings.meilisearchHost,
                        instructions: "Meilisearch host URL (e.g., http://localhost:7700)."|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "API Key"|t('search-index'),
                        id: 'meilisearchApiKey',
                        name: 'engineSettings[meilisearchApiKey]',
                        suggestEnvVars: true,
                        value: effectiveSettings.meilisearchApiKey,
                        instructions: "Your Meilisearch API Key (Master Key for admin, or Search Key for front-end)."|t('search-index'),
                    }) }}

                {% elseif engine.displayName == 'OpenSearch' %}
                    {{ forms.autosuggestField({
                        label: "Host"|t('search-index'),
                        id: 'opensearchHost',
                        name: 'engineSettings[opensearchHost]',
                        suggestEnvVars: true,
                        value: effectiveSettings.opensearchHost,
                        instructions: "OpenSearch host URL (e.g., https://localhost:9200)."|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "Username"|t('search-index'),
                        id: 'opensearchUsername',
                        name: 'engineSettings[opensearchUsername]',
                        suggestEnvVars: true,
                        value: effectiveSettings.opensearchUsername,
                    }) }}

                    {{ forms.autosuggestField({
                        label: "Password"|t('search-index'),
                        id: 'opensearchPassword',
                        name: 'engineSettings[opensearchPassword]',
                        suggestEnvVars: true,
                        value: effectiveSettings.opensearchPassword,
                    }) }}

                {% elseif engine.displayName == 'Typesense' %}
                    {{ forms.autosuggestField({
                        label: "Host"|t('search-index'),
                        id: 'typesenseHost',
                        name: 'engineSettings[typesenseHost]',
                        suggestEnvVars: true,
                        value: effectiveSettings.typesenseHost,
                        instructions: "Typesense server host (e.g., localhost or ts.example.com)."|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "Port"|t('search-index'),
                        id: 'typesensePort',
                        name: 'engineSettings[typesensePort]',
                        suggestEnvVars: true,
                        value: effectiveSettings.typesensePort,
                        instructions: "Typesense server port (default: 8108)."|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "Protocol"|t('search-index'),
                        id: 'typesenseProtocol',
                        name: 'engineSettings[typesenseProtocol]',
                        suggestEnvVars: true,
                        value: effectiveSettings.typesenseProtocol,
                        instructions: "Protocol to use (http or https)."|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "API Key"|t('search-index'),
                        id: 'typesenseApiKey',
                        name: 'engineSettings[typesenseApiKey]',
                        suggestEnvVars: true,
                        value: effectiveSettings.typesenseApiKey,
                        instructions: "Your Typesense Admin API Key."|t('search-index'),
                    }) }}
                {% endif %}
            </fieldset>

            {% if not loop.last %}
                <hr>
            {% endif %}
        {% endfor %}

        <hr>

        <h3>{{ "Integrations"|t('search-index') }}</h3>

        {{ forms.autosuggestField({
            label: "Voyage AI API Key"|t('search-index'),
            id: 'voyageApiKey',
            name: 'engineSettings[voyageApiKey]',
            suggestEnvVars: true,
            value: effectiveSettings.voyageApiKey,
            instructions: "API key for Voyage AI (used for embeddings and reranking). Get one at voyageai.com."|t('search-index'),
        }) }}

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "Save Engine Settings"|t('search-index') }}</button>
        </div>
    </form>

    <hr>

    {# ── Form 2: General Settings (protected by allowAdminChanges) ── #}
    <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('plugins/save-plugin-settings') }}
        {{ hiddenInput('pluginHandle', 'search-index') }}
        {{ redirectInput('search-index/settings') }}

        <h2>{{ "General Settings"|t('search-index') }}</h2>

        {% if not allowAdminChanges %}
            <p class="warning with-icon">{{ "Administrative changes are not allowed on this environment."|t('search-index') }}</p>
        {% endif %}

        <fieldset{% if not allowAdminChanges %} disabled{% endif %}>

        <h3>{{ "Engines"|t('search-index') }}</h3>

        <p class="light">{{ "Enable the search engines you want to use. Only enabled engines will appear when creating indexes."|t('search-index') }}</p>

        {% for engine in engineInfo %}
            {% set engineKey = engine.class|replace({'\\': '_'}) %}
            {% set isEnabled = enabledEngines is empty or engine.class in enabledEngines %}

            {{ forms.lightswitchField({
                label: engine.displayName,
                id: 'engine-toggle-' ~ engineKey,
                name: 'settings[enabledEngines][]',
                on: isEnabled,
                value: engine.class,
            }) }}
        {% endfor %}

        <hr>

        {{ forms.textField({
            label: "Batch Size"|t('search-index'),
            id: 'batchSize',
            name: 'settings[batchSize]',
            value: settings.batchSize,
            type: 'number',
            min: 1,
            max: 5000,
            instructions: "Number of elements to process per queue job during bulk indexing."|t('search-index'),
        }) }}

        {{ forms.lightswitchField({
            label: "Sync on Save"|t('search-index'),
            id: 'syncOnSave',
            name: 'settings[syncOnSave]',
            on: settings.syncOnSave,
            instructions: "Automatically update the search index when entries are saved."|t('search-index'),
        }) }}

        {{ forms.lightswitchField({
            label: "Index Relations"|t('search-index'),
            id: 'indexRelations',
            name: 'settings[indexRelations]',
            on: settings.indexRelations,
            instructions: "When a related element changes (e.g. a Category is renamed), re-index all entries that reference it. Disable if you prefer to manually re-index."|t('search-index'),
        }) }}

        </fieldset>

        {% if allowAdminChanges %}
            <div class="buttons">
                <button type="submit" class="btn submit">{{ "Save General Settings"|t('search-index') }}</button>
            </div>
        {% endif %}
    </form>
{% endblock %}
