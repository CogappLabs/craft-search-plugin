{% extends "search-index/_layouts/plugin" %}
{% import "_includes/forms" as forms %}

{% set title = "labels.searchIndexSettings"|t('search-index') %}
{% set selectedSubnavItem = 'settings' %}

{# Determine which engines are enabled (empty = all for backward compat) #}
{% set enabledEngines = settings.enabledEngines ?? [] %}

{% block content %}
    {% css %}
        .si-engine-section { margin-top: 24px; padding: 0; border: none; }
        .si-engine-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .si-engine-header h3 { margin: 0; }
    {% endcss %}

    {# ── Form 1: Engine Connections (always editable, saved to DB) ── #}
    <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('search-index/indexes/save-engine-settings') }}
        {{ redirectInput('search-index/settings') }}

        <h2>{{ "labels.engineConnections"|t('search-index') }}</h2>

        <p class="light">{{ "help.engineCredentialsAreStoredPerEnvironmentAndCanBeChangedRegardlessOfAdminSettings"|t('search-index') }}</p>

        {% for engine in engineInfo %}
            {% set engineKey = engine.class|replace({'\\': '_'}) %}

            <fieldset class="si-engine-section">
                <div class="si-engine-header">
                    <h3>{{ engine.displayName }}</h3>
                    {% if not engine.installed %}
                        <span class="status off" title="{{ 'errors.clientLibraryNotInstalled'|t('search-index') }}"></span>
                    {% endif %}
                </div>

                {% if not engine.installed %}
                    <p class="warning with-icon">{{ ("Client library not installed. Run:")|t('search-index') }} <code>composer require {{ engine.package }}</code></p>
                {% endif %}

                {% if engine.displayName == 'Algolia' %}
                    {{ forms.autosuggestField({
                        label: "labels.appId"|t('search-index'),
                        id: 'algoliaAppId',
                        name: 'engineSettings[algoliaAppId]',
                        suggestEnvVars: true,
                        value: effectiveSettings.algoliaAppId,
                        instructions: "help.yourAlgoliaApplicationId"|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "labels.adminApiKey"|t('search-index'),
                        id: 'algoliaApiKey',
                        name: 'engineSettings[algoliaApiKey]',
                        suggestEnvVars: true,
                        value: effectiveSettings.algoliaApiKey,
                        instructions: "help.yourAlgoliaAdminApiKeyUsedForIndexing"|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "labels.searchApiKey"|t('search-index'),
                        id: 'algoliaSearchApiKey',
                        name: 'engineSettings[algoliaSearchApiKey]',
                        suggestEnvVars: true,
                        value: effectiveSettings.algoliaSearchApiKey,
                        instructions: "help.yourAlgoliaSearchOnlyApiKeyUsedForFrontEndSearch"|t('search-index'),
                    }) }}

                {% elseif engine.displayName == 'Elasticsearch' %}
                    {{ forms.autosuggestField({
                        label: "labels.host"|t('search-index'),
                        id: 'elasticsearchHost',
                        name: 'engineSettings[elasticsearchHost]',
                        suggestEnvVars: true,
                        value: effectiveSettings.elasticsearchHost,
                        instructions: "help.elasticsearchHostUrlEGHttpsLocalhost9200"|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "labels.username"|t('search-index'),
                        id: 'elasticsearchUsername',
                        name: 'engineSettings[elasticsearchUsername]',
                        suggestEnvVars: true,
                        value: effectiveSettings.elasticsearchUsername,
                    }) }}

                    {{ forms.autosuggestField({
                        label: "labels.password"|t('search-index'),
                        id: 'elasticsearchPassword',
                        name: 'engineSettings[elasticsearchPassword]',
                        suggestEnvVars: true,
                        value: effectiveSettings.elasticsearchPassword,
                    }) }}

                    {{ forms.autosuggestField({
                        label: "labels.apiKey"|t('search-index'),
                        id: 'elasticsearchApiKey',
                        name: 'engineSettings[elasticsearchApiKey]',
                        suggestEnvVars: true,
                        value: effectiveSettings.elasticsearchApiKey,
                        instructions: "help.alternativeToUsernamePasswordAuthentication"|t('search-index'),
                    }) }}

                {% elseif engine.displayName == 'Meilisearch' %}
                    {{ forms.autosuggestField({
                        label: "labels.host"|t('search-index'),
                        id: 'meilisearchHost',
                        name: 'engineSettings[meilisearchHost]',
                        suggestEnvVars: true,
                        value: effectiveSettings.meilisearchHost,
                        instructions: "help.meilisearchHostUrlEGHttpLocalhost7700"|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "labels.apiKey"|t('search-index'),
                        id: 'meilisearchApiKey',
                        name: 'engineSettings[meilisearchApiKey]',
                        suggestEnvVars: true,
                        value: effectiveSettings.meilisearchApiKey,
                        instructions: "help.yourMeilisearchApiKeyMasterKeyForAdminOrSearchKeyForFrontEnd"|t('search-index'),
                    }) }}

                {% elseif engine.displayName == 'OpenSearch' %}
                    {{ forms.autosuggestField({
                        label: "labels.host"|t('search-index'),
                        id: 'opensearchHost',
                        name: 'engineSettings[opensearchHost]',
                        suggestEnvVars: true,
                        value: effectiveSettings.opensearchHost,
                        instructions: "help.opensearchHostUrlEGHttpsLocalhost9200"|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "labels.username"|t('search-index'),
                        id: 'opensearchUsername',
                        name: 'engineSettings[opensearchUsername]',
                        suggestEnvVars: true,
                        value: effectiveSettings.opensearchUsername,
                    }) }}

                    {{ forms.autosuggestField({
                        label: "labels.password"|t('search-index'),
                        id: 'opensearchPassword',
                        name: 'engineSettings[opensearchPassword]',
                        suggestEnvVars: true,
                        value: effectiveSettings.opensearchPassword,
                    }) }}

                {% elseif engine.displayName == 'Typesense' %}
                    {{ forms.autosuggestField({
                        label: "labels.host"|t('search-index'),
                        id: 'typesenseHost',
                        name: 'engineSettings[typesenseHost]',
                        suggestEnvVars: true,
                        value: effectiveSettings.typesenseHost,
                        instructions: "help.typesenseServerHostEGLocalhostOrTsExampleCom"|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "labels.port"|t('search-index'),
                        id: 'typesensePort',
                        name: 'engineSettings[typesensePort]',
                        suggestEnvVars: true,
                        value: effectiveSettings.typesensePort,
                        instructions: "help.typesenseServerPortDefault8108"|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "labels.protocol"|t('search-index'),
                        id: 'typesenseProtocol',
                        name: 'engineSettings[typesenseProtocol]',
                        suggestEnvVars: true,
                        value: effectiveSettings.typesenseProtocol,
                        instructions: "help.protocolToUseHttpOrHttps"|t('search-index'),
                    }) }}

                    {{ forms.autosuggestField({
                        label: "labels.apiKey"|t('search-index'),
                        id: 'typesenseApiKey',
                        name: 'engineSettings[typesenseApiKey]',
                        suggestEnvVars: true,
                        value: effectiveSettings.typesenseApiKey,
                        instructions: "help.yourTypesenseAdminApiKey"|t('search-index'),
                    }) }}
                {% endif %}
            </fieldset>

            {% if not loop.last %}
                <hr>
            {% endif %}
        {% endfor %}

        <hr>

        <h3>{{ "labels.integrations"|t('search-index') }}</h3>

        {{ forms.autosuggestField({
            label: "labels.voyageAiApiKey"|t('search-index'),
            id: 'voyageApiKey',
            name: 'engineSettings[voyageApiKey]',
            suggestEnvVars: true,
            value: effectiveSettings.voyageApiKey,
            instructions: "help.apiKeyForVoyageAiUsedForEmbeddingsAndRerankingGetOneAtVoyageaiCom"|t('search-index'),
        }) }}

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "labels.saveEngineSettings"|t('search-index') }}</button>
        </div>
    </form>

    <hr>

    {# ── Form 2: General Settings (protected by allowAdminChanges) ── #}
    <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('plugins/save-plugin-settings') }}
        {{ hiddenInput('pluginHandle', 'search-index') }}
        {{ redirectInput('search-index/settings') }}

        <h2>{{ "labels.generalSettings"|t('search-index') }}</h2>

        {% if not allowAdminChanges %}
            <p class="warning with-icon">{{ "errors.administrativeChangesAreNotAllowedOnThisEnvironment"|t('search-index') }}</p>
        {% endif %}

        <fieldset{% if not allowAdminChanges %} disabled{% endif %}>

        <h3>{{ "labels.engines"|t('search-index') }}</h3>

        <p class="light">{{ "states.enableTheSearchEnginesYouWantToUseOnlyEnabledEnginesWillAppearWhenCreatingIndexes"|t('search-index') }}</p>

        {% for engine in engineInfo %}
            {% set engineKey = engine.class|replace({'\\': '_'}) %}
            {% set isEnabled = enabledEngines is empty or engine.class in enabledEngines %}

            {{ forms.lightswitchField({
                label: engine.displayName,
                id: 'engine-toggle-' ~ engineKey,
                name: 'settings[enabledEngines][]',
                on: isEnabled,
                value: engine.class,
            }) }}
        {% endfor %}

        <hr>

        {{ forms.textField({
            label: "labels.batchSize"|t('search-index'),
            id: 'batchSize',
            name: 'settings[batchSize]',
            value: settings.batchSize,
            type: 'number',
            min: 1,
            max: 5000,
            instructions: "help.numberOfElementsToProcessPerQueueJobDuringBulkIndexing"|t('search-index'),
        }) }}

        {{ forms.lightswitchField({
            label: "labels.syncOnSave"|t('search-index'),
            id: 'syncOnSave',
            name: 'settings[syncOnSave]',
            on: settings.syncOnSave,
            instructions: "help.automaticallyUpdateTheSearchIndexWhenEntriesAreSaved"|t('search-index'),
        }) }}

        {{ forms.lightswitchField({
            label: "labels.indexRelations"|t('search-index'),
            id: 'indexRelations',
            name: 'settings[indexRelations]',
            on: settings.indexRelations,
            instructions: "help.whenARelatedElementChangesEGACategoryIsRenamedReIndexAllEntriesThatReferenceItDisableIfYouPreferToManuallyReIndex"|t('search-index'),
        }) }}

        </fieldset>

        {% if allowAdminChanges %}
            <div class="buttons">
                <button type="submit" class="btn submit">{{ "labels.saveGeneralSettings"|t('search-index') }}</button>
            </div>
        {% endif %}
    </form>
{% endblock %}
