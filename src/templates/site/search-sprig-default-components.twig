<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Search Sprig Default Components</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style type="text/tailwindcss">
        .htmx-indicator { display: none; margin-left: 0.5rem; @apply text-gray-600; }
        .htmx-request .htmx-indicator,
        .htmx-request.htmx-indicator { display: inline; }
    </style>
    {{ head() }}
</head>
<body class="font-sans m-8 leading-relaxed text-gray-900">
{{ beginBody() }}
<main class="max-w-4xl">
    <h1 class="text-2xl font-bold mb-2">Search Sprig Developer Demo</h1>
    <p class="text-gray-600">Route: <code class="bg-gray-100 px-1.5 py-0.5 rounded text-sm">{{ '/search-sprig--default-components' }}</code></p>
    <p class="text-gray-600">Developer/internal route (dev mode only). For production starter usage, publish templates and use <code class="bg-gray-100 px-1.5 py-0.5 rounded text-sm">templates/search-index/sprig/search-page.twig</code>.</p>

    {% if not firstIndexHandle %}
        <p>No enabled indexes are configured yet.</p>
    {% else %}
        {% set baseState = {
            indexHandle: selectedIndex,
            query: craft.app.request.getQueryParam('query', ''),
            doSearch: craft.app.request.getQueryParam('doSearch', 1) ? 1 : 0,
            perPage: craft.app.request.getQueryParam('perPage', 10),
            page: craft.app.request.getQueryParam('page', 1),
            sortField: craft.app.request.getQueryParam('sortField', ''),
            sortDirection: craft.app.request.getQueryParam('sortDirection', 'desc'),
            showRaw: isDevMode ? 1 : 0,
            showRoleDebug: 1,
            autoSearch: 1,
            hideSubmit: 1,
        } %}

        <section class="border border-gray-300 p-4 rounded-lg mb-5">
            <h2 class="text-lg font-semibold mb-2">Starter (Recommended)</h2>
            <p>Publish starter templates for production usage:</p>
            <pre class="overflow-x-auto" tabindex="0" role="region" aria-label="Publish command"><code class="bg-gray-100 px-1.5 py-0.5 rounded text-sm">php craft search-index/index/publish-sprig-templates</code></pre>
            <p>Then use:</p>
            <pre class="overflow-x-auto" tabindex="0" role="region" aria-label="Include template"><code class="bg-gray-100 px-1.5 py-0.5 rounded text-sm">{{ "{% include 'search-index/sprig/search-page' %}"|replace({'&':'&amp;','<':'&lt;','>':'&gt;'})|raw }}</code></pre>
        </section>

        <section class="border border-gray-300 p-4 rounded-lg mb-5">
            <h2 class="text-lg font-semibold mb-2">Quick Alias Example</h2>
            <p>Drop this into a template to test quickly:</p>
            <pre class="overflow-x-auto" tabindex="0" role="region" aria-label="Quick alias example"><code class="bg-gray-100 px-1.5 py-0.5 rounded text-sm">{{ "{{ searchIndexSprig('frontend.search-box', { indexHandle: '" ~ selectedIndex ~ "', perPage: 10 }) }}"|replace({'&':'&amp;','<':'&lt;','>':'&gt;'})|raw }}</code></pre>
        </section>

        <section class="border border-gray-300 p-4 rounded-lg mb-5">
            <h2 class="text-lg font-semibold mb-2">Twig Helpers (Examples)</h2>
            <p class="text-gray-600">These snippets show helper usage you can copy into your own templates.</p>
            <pre class="overflow-x-auto" tabindex="0" role="region" aria-label="Sprig component helper"><code class="bg-gray-100 px-1.5 py-0.5 rounded text-sm">{{ "{{ searchIndexSprigComponent('frontend.search-box') }}"|replace({'&':'&amp;','<':'&lt;','>':'&gt;'})|raw }}</code></pre>
            <pre class="overflow-x-auto" tabindex="0" role="region" aria-label="Build URL helper"><code class="bg-gray-100 px-1.5 py-0.5 rounded text-sm">{{ "{{ craft.searchIndex.buildUrl('/search', { q: query, page: 2 }) }}"|replace({'&':'&amp;','<':'&lt;','>':'&gt;'})|raw }}</code></pre>
            <pre class="overflow-x-auto" tabindex="0" role="region" aria-label="State inputs helper"><code class="bg-gray-100 px-1.5 py-0.5 rounded text-sm">{{ "{{ craft.searchIndex.stateInputs({ q: query, page: page, region: activeRegions }, { exclude: 'q' }) }}"|replace({'&':'&amp;','<':'&lt;','>':'&gt;'})|raw }}</code></pre>
            <pre class="overflow-x-auto" tabindex="0" role="region" aria-label="Search document field example"><code class="bg-gray-100 px-1.5 py-0.5 rounded text-sm">{{ "{% set searchDoc = entry.mySearchDocField %}\n{% set image = searchDoc ? searchDoc.getImage() : null %}\n{% if image %}\n  <img src=\"{{ image.getUrl({ width: 480 }) }}\" alt=\"{{ image.alt ?? searchDoc.getTitle() }}\">\n{% endif %}"|replace({'&':'&amp;','<':'&lt;','>':'&gt;'})|raw }}</code></pre>
        </section>

        <section class="border border-gray-300 p-4 rounded-lg mb-5">
            <h2 class="text-lg font-semibold mb-2">Live Demo</h2>
            <form class="mb-4">
                <label for="demo-index" class="text-sm text-gray-600 mr-2">Index</label>
                <select id="demo-index" class="border border-gray-300 rounded px-2 py-1 text-sm" onchange="window.location.search='?index='+encodeURIComponent(this.value)">
                    {% for option in indexOptions %}
                        <option value="{{ option.value }}"{% if option.value == selectedIndex %} selected{% endif %}>{{ option.label }} ({{ option.value }})</option>
                    {% endfor %}
                </select>
            </form>
            {{ searchIndexSprig('frontend.search-box', baseState) }}
        </section>

        {# Highlighting demo #}
        <section class="border border-gray-300 p-4 rounded-lg mb-5">
            <h2 class="text-lg font-semibold mb-2">Highlighting</h2>
            <p class="text-gray-600 text-sm mb-3">Search with <code class="bg-gray-100 px-1.5 py-0.5 rounded text-sm">highlight: true</code> and <code class="bg-gray-100 px-1.5 py-0.5 rounded text-sm">suggest: true</code>.</p>
            {% set highlightQuery = craft.app.request.getQueryParam('hq') ?? '' %}
            <form method="get" class="flex gap-2 mb-4">
                <input type="hidden" name="index" value="{{ selectedIndex }}">
                <input type="text" name="hq" value="{{ highlightQuery }}" placeholder="Search with highlights..." class="border border-gray-300 rounded px-3 py-1.5 text-sm text-gray-900 flex-1">
                <button type="submit" class="bg-gray-900 text-white px-4 py-1.5 rounded text-sm hover:bg-gray-700 transition-colors cursor-pointer">Search</button>
            </form>
            {% if highlightQuery|length > 0 %}
                {% set highlightResults = craft.searchIndex.search(selectedIndex, highlightQuery, {
                    highlight: true,
                    suggest: true,
                    perPage: 5,
                }) %}
                {% if highlightResults.suggestions is not empty %}
                    <p class="text-sm text-gray-600 mb-3">Did you mean:
                        {% for suggestion in highlightResults.suggestions %}
                            <a href="?index={{ selectedIndex }}&hq={{ suggestion|url_encode }}" class="text-blue-600 hover:underline">{{ suggestion }}</a>{{ not loop.last ? ', ' }}
                        {% endfor %}?
                    </p>
                {% endif %}
                <p class="text-xs text-gray-600 mb-3">{{ highlightResults.totalHits }} result{{ highlightResults.totalHits != 1 ? 's' }} in {{ highlightResults.processingTimeMs }}ms</p>
                {% if highlightResults.hits|length %}
                    <ul class="list-none m-0 p-0 space-y-4">
                        {% for hit in highlightResults.hits %}
                            <li class="border border-gray-200 rounded-lg p-4">
                                {% if hit._highlights.title is defined %}
                                    <h3 class="text-sm font-semibold m-0">{{ hit._highlights.title|first|raw }}</h3>
                                {% else %}
                                    <h3 class="text-sm font-semibold m-0">{{ hit.title ?? hit.name ?? hit.objectID }}</h3>
                                {% endif %}
                                {% for field, fragments in hit._highlights|filter((v, k) => k != 'title') %}
                                    {% for fragment in fragments %}
                                        <p class="text-xs text-gray-600 mt-1 m-0">...{{ fragment|raw }}...</p>
                                    {% endfor %}
                                {% endfor %}
                                {% if hit.objectID is defined %}
                                    <p class="text-[10px] text-gray-600 mt-1 m-0">ID: {{ hit.objectID }}{% if hit._score is defined %} / score: {{ hit._score }}{% endif %}</p>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-sm text-gray-600">No results.</p>
                {% endif %}
            {% endif %}
        </section>
    {% endif %}
</main>
{% js %}{{ source('search-index/stubs/sprig/js/histogram.js') }}{% endjs %}
{{ endBody() }}
</body>
</html>
