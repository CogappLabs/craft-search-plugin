{# Range filters — min/max number inputs for numeric fields.            #}
{# Shows stats-derived bounds as placeholders when available.           #}
{# "Distribution" button opens a <dialog> with SVG histogram + inputs. #}

{% set stats = data.stats ?? {} %}
{% set histograms = data.histograms ?? {} %}

{% for fieldName in numericFields %}
    {% set fieldStats = stats[fieldName] ?? {} %}
    {% set currentRange = filters[fieldName] ?? {} %}
    {% set fieldHistogram = histograms[fieldName] ?? [] %}
    <fieldset>
        <legend>{{ fieldName }}</legend>

        <form>
            {# Hidden state — excludes filters (handled below) #}
            {{ craft.searchIndex.stateInputs(state|merge({
                query: query,
                perPage: perPage,
                sortField: sortField,
                sortDirection: sortDirection,
                page: 1,
            }), { exclude: 'filters' }) }}

            {# Preserve other filters as hidden inputs #}
            {% for otherField, otherValues in filters|filter((v, k) => k != fieldName) %}
                {% if otherValues.min is defined or otherValues.max is defined %}
                    {% if otherValues.min is defined %}<input type="hidden" name="filters[{{ otherField }}][min]" value="{{ otherValues.min }}">{% endif %}
                    {% if otherValues.max is defined %}<input type="hidden" name="filters[{{ otherField }}][max]" value="{{ otherValues.max }}">{% endif %}
                {% else %}
                    {% for v in otherValues %}
                        <input type="hidden" name="filters[{{ otherField }}][]" value="{{ v }}">
                    {% endfor %}
                {% endif %}
            {% endfor %}

            <label>
                Min
                <input
                    id="si-range-min-{{ fieldName }}"
                    type="number"
                    name="filters[{{ fieldName }}][min]"
                    value="{{ currentRange.min ?? '' }}"
                    placeholder="{{ fieldStats.min is defined ? fieldStats.min : '' }}"
                    step="any"
                >
            </label>
            <label>
                Max
                <input
                    id="si-range-max-{{ fieldName }}"
                    type="number"
                    name="filters[{{ fieldName }}][max]"
                    value="{{ currentRange.max ?? '' }}"
                    placeholder="{{ fieldStats.max is defined ? fieldStats.max : '' }}"
                    step="any"
                >
            </label>
            <button
                sprig
                id="si-range-apply-{{ fieldName }}"
                type="button"
                s-method="post"
                s-include="closest form"
                s-swap="outerHTML transition:true"
                s-target="#si-search"
            >
                Apply
            </button>
            {% if fieldHistogram|length %}
                <button type="button"
                    class="si-histogram-trigger"
                    data-histogram="{{ fieldHistogram|json_encode }}"
                    data-stats="{{ fieldStats|json_encode }}"
                    data-field="{{ fieldName }}"
                    data-dialog-id="si-histogram-dialog-{{ fieldName }}"
                    style="display:flex;align-items:center;justify-content:center;gap:5px;width:100%;padding:4px 12px;font-size:0.75rem;text-transform:lowercase;color:#64748b;background:transparent;border:1px solid #94a3b8;cursor:pointer;"
                >
                    <svg width="12" height="10" viewBox="0 0 14 12" fill="currentColor" style="display:block;"><rect x="0" y="6" width="3" height="6" opacity=".5"/><rect x="4" y="2" width="3" height="10"/><rect x="8" y="4" width="3" height="8" opacity=".7"/><rect x="12" y="8" width="2" height="4" opacity=".3"/></svg>
                    distribution
                </button>
            {% endif %}
        </form>

        {# Histogram modal (outside form, no Sprig state) #}
        {% if fieldHistogram|length %}
            <dialog id="si-histogram-dialog-{{ fieldName }}" style="max-width:600px;width:90vw;border:1px solid #cbd5e1;border-radius:8px;padding:0;background:#fff;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);margin:auto;">
                <div style="padding:1.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                        <strong>{{ fieldName }} distribution</strong>
                        <button type="button" class="si-histogram-close" style="background:none;border:none;font-size:1.25rem;cursor:pointer;color:#64748b;padding:0.25rem;" aria-label="Close">&times;</button>
                    </div>
                    <svg style="width:100%;height:auto;"></svg>
                    <div style="display:flex;gap:1rem;margin:1rem 0;align-items:center;">
                        <label style="flex:1;">Min <input type="number" class="si-histogram-min" value="{{ currentRange.min ?? '' }}" placeholder="{{ fieldStats.min ?? '' }}" step="any" style="width:100%;padding:0.25rem 0.5rem;border:1px solid #cbd5e1;border-radius:4px;"></label>
                        <label style="flex:1;">Max <input type="number" class="si-histogram-max" value="{{ currentRange.max ?? '' }}" placeholder="{{ fieldStats.max ?? '' }}" step="any" style="width:100%;padding:0.25rem 0.5rem;border:1px solid #cbd5e1;border-radius:4px;"></label>
                    </div>
                    <button type="button" class="si-histogram-apply"
                        data-min-target="si-range-min-{{ fieldName }}"
                        data-max-target="si-range-max-{{ fieldName }}"
                        data-apply-target="si-range-apply-{{ fieldName }}"
                        style="display:block;width:100%;padding:4px 12px;font-size:0.75rem;text-transform:lowercase;text-align:center;background:transparent;color:#64748b;border:1px solid #94a3b8;cursor:pointer;">apply</button>
                </div>
            </dialog>
        {% endif %}
    </fieldset>
{% endfor %}
