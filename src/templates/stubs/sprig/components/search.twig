{#
    Search Index — Main Sprig Search Component
    ===========================================
    This is the entry point Sprig template. It calls searchContext() once to
    get roles, facet fields, sort options, and search results, then includes
    the individual component partials.

    Customise layout by rearranging the includes below.
    Customise markup by editing the individual component files.

    Required variable (passed from the parent template):
        indexHandle  — the search index handle (string)

    Optional state variables (all have sensible defaults):
        query, page, perPage, sortField, sortDirection,
        filters, doSearch, autoSearch, hideSubmit, clearFilters,
        searchPagePath (for URL push — set to your search page path)
#}

{# ── State defaults ─────────────────────────────────────────────────── #}

{% set indexHandle = indexHandle ?? '' %}
{% set query = query ?? '' %}
{% set page = page ?? 1 %}
{% set perPage = perPage ?? 10 %}
{% set sortField = sortField ?? '' %}
{% set sortDirection = sortDirection ?? 'desc' %}
{% set filters = filters ?? {} %}
{% set doSearch = doSearch ?? 0 %}
{% set autoSearch = autoSearch ?? 0 %}
{% set hideSubmit = hideSubmit ?? 0 %}
{% set clearFilters = clearFilters ?? 0 %}
{% set searchPagePath = searchPagePath ?? '' %}

{# ── Facet checkbox handling ───────────────────────────────────────── #}
{# Sprig re-sends component state (including filters) via data-hx-vals #}
{# alongside form inputs, causing duplicates. Facet forms use separate  #}
{# siFacetField / siFacetValues params so the checkbox state is         #}
{# authoritative for the active facet field.                            #}
{# (Sprig disallows variable names starting with underscore.)           #}

{% set siFacetField = siFacetField ?? '' %}
{% set siFacetValues = siFacetValues ?? [] %}

{% if siFacetField %}
    {% if siFacetValues|length %}
        {% set filters = filters|merge({ (siFacetField): siFacetValues }) %}
    {% else %}
        {% set filters = filters|filter((v, k) => k != siFacetField) %}
    {% endif %}
{% endif %}

{# Deduplicate filter values (Sprig state + form hidden inputs overlap) #}
{% set cleanFilters = {} %}
{% for k, v in filters %}
    {% if v.min is defined or v.max is defined %}
        {% set cleanFilters = cleanFilters|merge({ (k): v }) %}
    {% else %}
        {% set cleanFilters = cleanFilters|merge({
            (k): v|reduce((carry, item) => item in carry ? carry : carry|merge([item]), [])
        }) %}
    {% endif %}
{% endfor %}
{% set filters = cleanFilters %}

{# ── Clear filters action ──────────────────────────────────────────── #}

{% if siToBool(clearFilters) %}
    {% set filters = {} %}
    {% set page = 1 %}
{% endif %}

{# ── Build search context (roles, facets, sort options, results) ──── #}

{% set ctx = craft.searchIndex.searchContext(indexHandle, {
    query: query,
    page: page,
    perPage: perPage,
    sortField: sortField,
    sortDirection: sortDirection,
    filters: filters,
    doSearch: doSearch,
}) %}

{% set roles = ctx.roles %}
{% set facetFields = ctx.facetFields %}
{% set numericFields = ctx.numericFields ?? [] %}
{% set sortOptions = ctx.sortOptions %}
{% set data = ctx.data %}

{# Pagination helpers #}
{% set totalPages = data and data.success ? (data.totalPages ?? 0) : 0 %}
{% set currentPage = data and data.success ? (data.page ?? page) : page %}

{# Shared state for hidden inputs #}
{% set state = {
    indexHandle: indexHandle,
    doSearch: 1,
    facetFields: facetFields,
    filters: filters,
} %}

{# Variables passed to all sub-templates #}
{% set shared = {
    indexHandle: indexHandle,
    query: query,
    page: page,
    perPage: perPage,
    sortField: sortField,
    sortDirection: sortDirection,
    filters: filters,
    doSearch: doSearch,
    autoSearch: autoSearch,
    hideSubmit: hideSubmit,
    roles: roles,
    facetFields: facetFields,
    numericFields: numericFields,
    sortOptions: sortOptions,
    data: data,
    state: state,
    totalPages: totalPages,
    currentPage: currentPage,
} %}


{# ── Push URL on Sprig requests (bookmarkable search URLs) ─────────── #}
{# Set searchPagePath in your parent template to enable URL push.       #}

{% if searchPagePath and sprig.isRequest %}
    {% set _urlParts = [] %}
    {% if query %}{% set _urlParts = _urlParts|merge(['query=' ~ query|url_encode]) %}{% endif %}
    {% for field, values in filters %}
        {% if values.min is defined or values.max is defined %}
            {% if values.min is defined %}{% set _urlParts = _urlParts|merge(['filters[' ~ field ~ '][min]=' ~ values.min|url_encode]) %}{% endif %}
            {% if values.max is defined %}{% set _urlParts = _urlParts|merge(['filters[' ~ field ~ '][max]=' ~ values.max|url_encode]) %}{% endif %}
        {% else %}
            {% for v in values %}
                {% set _urlParts = _urlParts|merge(['filters[' ~ field ~ '][]=' ~ v|url_encode]) %}
            {% endfor %}
        {% endif %}
    {% endfor %}
    {% if currentPage > 1 %}{% set _urlParts = _urlParts|merge(['page=' ~ currentPage]) %}{% endif %}
    {% if sortField %}{% set _urlParts = _urlParts|merge(['sortField=' ~ sortField|url_encode, 'sortDirection=' ~ sortDirection|url_encode]) %}{% endif %}
    {% do sprig.pushUrl(searchPagePath ~ (_urlParts|length ? '?' ~ _urlParts|join('&') : '')) %}
{% endif %}

{# ── Layout ─────────────────────────────────────────────────────────── #}
{# Rearrange these includes or wrap them in your own grid/flex layout.  #}
{# All Sprig forms target this outer <div> so the whole component swaps #}
{# as one unit.                                                         #}

<div id="si-search">
    {% include 'search-index/sprig/components/search-form' with shared only %}

    {% if siToBool(doSearch) and filters|length %}
        {% include 'search-index/sprig/components/search-filters' with shared only %}
    {% endif %}

    {% if siToBool(doSearch) %}
        {% include 'search-index/sprig/components/search-results' with shared only %}
    {% endif %}

    {% if data and data.success and data.facets is defined and data.facets %}
        {% include 'search-index/sprig/components/search-facets' with shared only %}
    {% endif %}

    {% if numericFields|length and data and data.success %}
        {% include 'search-index/sprig/components/search-range-filters' with shared only %}
    {% endif %}

    {% if totalPages > 1 %}
        {% include 'search-index/sprig/components/search-pagination' with shared only %}
    {% endif %}
</div>
