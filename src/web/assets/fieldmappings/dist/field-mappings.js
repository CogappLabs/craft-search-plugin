const P={error:"si-row-error",warning:"si-row-warning",null:"si-row-null"};(()=>{const p=document.getElementById("field-mappings-container");if(!p)return;const b=document.getElementById("si-field-mappings");if(b){const e=b.querySelectorAll("select.si-role-input");e.forEach(t=>{t.addEventListener("change",()=>{const n=t.value;n&&e.forEach(l=>{l!==t&&l.value===n&&(l.value="",f(l))}),f(t)})})}function f(e){const t=e.closest("tr");if(!t)return;const n=t.querySelector(".si-role-chip");n&&(n.dataset.role=e.value,n.textContent=e.value,e.value?n.setAttribute("aria-label",`Role: ${e.value}`):n.removeAttribute("aria-label"))}const S=p.dataset.indexId;if(!S)return;const O=p.dataset.tValidationFailed||"Validation failed.",V=p.dataset.tRequestFailed||"Validation request failed.",T=p.dataset.tCopied||"Copied to clipboard.",A=p.dataset.tCopyFailed||"Failed to copy to clipboard.",m=document.getElementById("validate-fields-btn"),$=document.getElementById("copy-markdown-btn"),w=document.getElementById("copy-markdown-warnings-btn");let y=null;if(!m||!$||!w)return;$.addEventListener("click",()=>{if(!y)return;const e=N(y,null,"");I(e)}),w.addEventListener("click",()=>{if(!y)return;const e=N(y,t=>t.status==="warning"||t.status==="null"||t.status==="error"," (Warnings, Errors & Nulls)");I(e)}),m.addEventListener("click",()=>{m.classList.add("loading"),m.disabled=!0;const e=document.getElementById("validate-results");Craft.sendActionRequest("POST","search-index/field-mappings/validate",{data:{indexId:S}}).then(t=>{const n=t.data;if(!n.success){Craft.cp.displayError(n.message||O),e?.classList.add("hidden");return}y=n,q(n)}).catch(()=>{Craft.cp.displayError(V),e?.classList.add("hidden")}).finally(()=>{m.classList.remove("loading"),m.disabled=!1})});function q(e){const t=document.getElementById("validate-results"),n=document.getElementById("validate-summary"),l=document.getElementById("validate-entries");if(!t||!n||!l)return;t.classList.remove("hidden"),l.innerHTML="";let s=0,c=0,u=0,g=0;e.results.forEach(a=>{a.status==="ok"?s++:a.status==="error"?u++:a.status==="null"?g++:c++});const r=[`${e.results.length} fields validated.`];s>0&&r.push(`${s} OK`),c>0&&r.push(`${c} warning(s)`),u>0&&r.push(`${u} error(s)`),g>0&&r.push(`${g} with no data`),n.textContent=r.join(" â€” ");const C=document.createElement("table");C.className="data fullwidth";const L=document.createElement("thead");L.innerHTML="<tr><th>Index Field</th><th>Index Type</th><th>Source Entry</th><th>PHP Type</th><th>Value</th><th>Status</th></tr>",C.appendChild(L);const F=document.createElement("tbody");e.results.forEach(a=>{const i=document.createElement("tr"),k=P[a.status];k&&(i.className=k);const B=document.createElement("td"),R=document.createElement("code");R.textContent=a.indexFieldName,B.appendChild(R),i.appendChild(B);const H=document.createElement("td");H.textContent=a.indexFieldType,i.appendChild(H);const E=document.createElement("td");if(a.entryId){E.textContent=`${a.entryTitle} `;const o=document.createElement("span");o.className="light",o.textContent=`#${a.entryId}`,E.appendChild(o)}else{const o=document.createElement("span");o.className="light",o.textContent="no data found",E.appendChild(o)}i.appendChild(E);const M=document.createElement("td"),x=document.createElement("code");x.textContent=a.phpType,x.className="light",M.appendChild(x),i.appendChild(M);const h=document.createElement("td");if(h.className="si-value-cell",a.value===null){const o=document.createElement("span");o.className="light",o.textContent="null",h.appendChild(o)}else if(typeof a.value=="object"){const o=document.createElement("code");o.textContent=JSON.stringify(a.value),o.title=JSON.stringify(a.value,null,2),h.appendChild(o)}else h.textContent=String(a.value),h.title=String(a.value);i.appendChild(h);const d=document.createElement("td");a.status==="ok"?d.innerHTML='<span class="status green"></span>':a.status==="error"?(d.innerHTML='<span class="status red"></span>',v(d,a.warning)):a.status==="null"?(d.innerHTML='<span class="status"></span>',v(d,a.warning)):(d.innerHTML='<span class="status orange"></span>',v(d,a.warning)),i.appendChild(d),F.appendChild(i)}),C.appendChild(F),l.appendChild(C),t.scrollIntoView({behavior:"smooth",block:"start"}),t.setAttribute("tabindex","-1"),t.focus({preventScroll:!0})}function v(e,t){if(!t)return;const n=document.createElement("span");n.className="light small",n.textContent=` ${t}`,e.appendChild(n)}function I(e){navigator.clipboard.writeText(e).then(()=>{Craft.cp.displayNotice(T)},()=>{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();const n=document.execCommand("copy");document.body.removeChild(t),n?Craft.cp.displayNotice(T):Craft.cp.displayError(A)})}function N(e,t,n){const l=[];return l.push(`# Field Mapping Validation: ${e.indexName} (\`${e.indexHandle}\`)${n}`),l.push(""),e.entryTypeNames?.length&&l.push(`**Entry types:** ${e.entryTypeNames.join(", ")}`),l.push(""),l.push("| Index Field | Index Type | Source Entry | PHP Type | Value | Status |"),l.push("|---|---|---|---|---|---|"),e.results.forEach(s=>{if(t&&!t(s))return;let c=s.entryId?`${s.entryTitle} (#${s.entryId})`:"_no data_",u=s.value===null?"_null_":typeof s.value=="object"?`\`${JSON.stringify(s.value)}\``:String(s.value).length>60?`${String(s.value).substring(0,60)}...`:String(s.value);u=u.replace(/\|/g,"\\|"),c=c.replace(/\|/g,"\\|");let r=s.status==="ok"?"OK":s.status==="error"?"ERROR":s.status==="null"?"--":"WARN";s.warning&&(r+=` ${s.warning.replace(/\|/g,"\\|")}`),l.push(`| \`${s.indexFieldName}\` | ${s.indexFieldType} | ${c} | \`${s.phpType}\` | ${u} | ${r} |`)}),l.push(""),l.join(`
`)}})();
