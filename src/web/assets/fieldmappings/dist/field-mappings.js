const F={error:"si-row-error",warning:"si-row-warning",null:"si-row-null"};(()=>{const x=document.getElementById("field-mappings-container");if(!x)return;const b=document.getElementById("si-field-mappings");if(b){const e=b.querySelectorAll("select.si-role-input");e.forEach(t=>{t.addEventListener("change",()=>{const n=t.value;n&&e.forEach(l=>{l!==t&&l.value===n&&(l.value="",f(l))}),f(t)})})}function f(e){const t=e.closest("tr");if(!t)return;const n=t.querySelector(".si-role-chip");n&&(n.dataset.role=e.value,n.textContent=e.value,e.value?n.setAttribute("aria-label",`Role: ${e.value}`):n.removeAttribute("aria-label"))}const T=x.dataset.indexId;if(!T)return;const p=document.getElementById("validate-fields-btn"),S=document.getElementById("copy-markdown-btn"),$=document.getElementById("copy-markdown-warnings-btn");let h=null;if(!p||!S||!$)return;S.addEventListener("click",()=>{if(!h)return;const e=I(h,null,"");w(e)}),$.addEventListener("click",()=>{if(!h)return;const e=I(h,t=>t.status==="warning"||t.status==="null"||t.status==="error"," (Warnings, Errors & Nulls)");w(e)}),p.addEventListener("click",()=>{p.classList.add("loading"),p.disabled=!0;const e=document.getElementById("validate-results");Craft.sendActionRequest("POST","search-index/field-mappings/validate",{data:{indexId:T}}).then(t=>{const n=t.data;if(!n.success){Craft.cp.displayError(n.message||"Validation failed."),e?.classList.add("hidden");return}h=n,R(n)}).catch(()=>{Craft.cp.displayError("Validation request failed."),e?.classList.add("hidden")}).finally(()=>{p.classList.remove("loading"),p.disabled=!1})});function R(e){const t=document.getElementById("validate-results"),n=document.getElementById("validate-summary"),l=document.getElementById("validate-entries");if(!t||!n||!l)return;t.classList.remove("hidden"),l.innerHTML="";let s=0,c=0,u=0,y=0;e.results.forEach(a=>{a.status==="ok"?s++:a.status==="error"?u++:a.status==="null"?y++:c++});const o=[`${e.results.length} fields validated.`];s>0&&o.push(`${s} OK`),c>0&&o.push(`${c} warning(s)`),u>0&&o.push(`${u} error(s)`),y>0&&o.push(`${y} with no data`),n.textContent=o.join(" â€” ");const g=document.createElement("table");g.className="data fullwidth";const N=document.createElement("thead");N.innerHTML="<tr><th>Index Field</th><th>Index Type</th><th>Source Entry</th><th>PHP Type</th><th>Value</th><th>Status</th></tr>",g.appendChild(N);const L=document.createElement("tbody");e.results.forEach(a=>{const i=document.createElement("tr"),k=F[a.status];k&&(i.className=k);const B=document.createElement("td"),H=document.createElement("code");H.textContent=a.indexFieldName,B.appendChild(H),i.appendChild(B);const M=document.createElement("td");M.textContent=a.indexFieldType,i.appendChild(M);const E=document.createElement("td");if(a.entryId){E.textContent=`${a.entryTitle} `;const r=document.createElement("span");r.className="light",r.textContent=`#${a.entryId}`,E.appendChild(r)}else{const r=document.createElement("span");r.className="light",r.textContent="no data found",E.appendChild(r)}i.appendChild(E);const O=document.createElement("td"),v=document.createElement("code");v.textContent=a.phpType,v.className="light",O.appendChild(v),i.appendChild(O);const m=document.createElement("td");if(m.className="si-value-cell",a.value===null){const r=document.createElement("span");r.className="light",r.textContent="null",m.appendChild(r)}else if(typeof a.value=="object"){const r=document.createElement("code");r.textContent=JSON.stringify(a.value),r.title=JSON.stringify(a.value,null,2),m.appendChild(r)}else m.textContent=String(a.value),m.title=String(a.value);i.appendChild(m);const d=document.createElement("td");a.status==="ok"?d.innerHTML='<span class="status green"></span>':a.status==="error"?(d.innerHTML='<span class="status red"></span>',C(d,a.warning)):a.status==="null"?(d.innerHTML='<span class="status"></span>',C(d,a.warning)):(d.innerHTML='<span class="status orange"></span>',C(d,a.warning)),i.appendChild(d),L.appendChild(i)}),g.appendChild(L),l.appendChild(g),t.scrollIntoView({behavior:"smooth",block:"start"})}function C(e,t){if(!t)return;const n=document.createElement("span");n.className="light small",n.textContent=` ${t}`,e.appendChild(n)}function w(e){navigator.clipboard.writeText(e).then(()=>{Craft.cp.displayNotice("Copied to clipboard.")},()=>{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();const n=document.execCommand("copy");document.body.removeChild(t),n?Craft.cp.displayNotice("Copied to clipboard."):Craft.cp.displayError("Failed to copy to clipboard.")})}function I(e,t,n){const l=[];return l.push(`# Field Mapping Validation: ${e.indexName} (\`${e.indexHandle}\`)${n}`),l.push(""),e.entryTypeNames?.length&&l.push(`**Entry types:** ${e.entryTypeNames.join(", ")}`),l.push(""),l.push("| Index Field | Index Type | Source Entry | PHP Type | Value | Status |"),l.push("|---|---|---|---|---|---|"),e.results.forEach(s=>{if(t&&!t(s))return;let c=s.entryId?`${s.entryTitle} (#${s.entryId})`:"_no data_",u=s.value===null?"_null_":typeof s.value=="object"?`\`${JSON.stringify(s.value)}\``:String(s.value).length>60?`${String(s.value).substring(0,60)}...`:String(s.value);u=u.replace(/\|/g,"\\|"),c=c.replace(/\|/g,"\\|");let o=s.status==="ok"?"OK":s.status==="error"?"ERROR":s.status==="null"?"--":"WARN";s.warning&&(o+=` ${s.warning.replace(/\|/g,"\\|")}`),l.push(`| \`${s.indexFieldName}\` | ${s.indexFieldType} | ${c} | \`${s.phpType}\` | ${u} | ${o} |`)}),l.push(""),l.join(`
`)}})();
