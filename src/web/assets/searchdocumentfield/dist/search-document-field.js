(()=>{document.querySelectorAll(".search-document-field[data-field-id]").forEach(F);function F(c){const H=c.querySelector(".sdf-index-handle"),E=c.querySelector(".sdf-document-id"),L=c.querySelector(".sdf-section-handle"),S=c.querySelector(".sdf-entry-type-handle"),g=c.querySelector(".sdf-query"),A=c.querySelector(".sdf-results"),C=c.querySelector(".sdf-results-list"),T=c.querySelector(".sdf-selected"),_=c.querySelector(".sdf-selected-title"),q=c.querySelector(".sdf-search"),b=c.querySelector(".sdf-clear");if(!H||!E||!L||!S||!g||!A||!C||!T||!_||!q||!b)return;const D=H,o=E,I=L,x=S,r=g,k=A,i=C,P=T,m=_,p=q;let $,s=-1,d=[];const N=parseInt(c.dataset.perPage||String(10),10)||10;r.addEventListener("input",function(){clearTimeout($);const t=this.value.trim();if(t.length<1){h();return}$=setTimeout(()=>O(t),300)}),r.addEventListener("keydown",t=>{if(!(!d.length&&t.key!=="Escape"))switch(t.key){case"ArrowDown":t.preventDefault(),R(s<d.length-1?s+1:0);break;case"ArrowUp":t.preventDefault(),R(s>0?s-1:d.length-1);break;case"Enter":if(t.preventDefault(),s>=0&&s<d.length){const e=d[s],n=e.title||e.name||e.objectID||"",l=e.uri||"";v(e.objectID,n,l,e.sectionHandle||"",e.entryTypeHandle||"")}break;case"Escape":t.preventDefault(),h();break}});function R(t){s=t;const e=i.querySelectorAll(".sdf-result-item");e.forEach((n,l)=>{n.classList.toggle("sdf-active",l===s)}),s>=0&&e[s]?(r.setAttribute("aria-activedescendant",e[s].id),e[s].scrollIntoView({block:"nearest"})):r.removeAttribute("aria-activedescendant")}function w(){k.classList.remove("hidden"),r.setAttribute("aria-expanded","true")}function h(){k.classList.add("hidden"),r.setAttribute("aria-expanded","false"),r.removeAttribute("aria-activedescendant"),s=-1,d=[]}function O(t){p.classList.add("sdf-loading"),Craft.sendActionRequest("POST","search-index/search/search",{data:{indexHandle:D.value,query:t,perPage:N}}).then(e=>{const{data:n}=e;if(i.innerHTML="",s=-1,d=[],!n.success||!n.hits||n.hits.length===0){i.innerHTML='<li class="sdf-no-results"><em>No results found.</em></li>',w();return}d=n.hits;const l=i.id;n.hits.forEach((a,u)=>{const f=document.createElement("li");f.className="sdf-result-item",f.id=`${l}-option-${u}`,f.setAttribute("role","option");const M=a.title||a.name||a.objectID||"",y=a.uri||"",j=a.sectionHandle||"",U=a.entryTypeHandle||"",B=[j,U].filter(Boolean).join(" / ");f.innerHTML=`<strong>${Craft.escapeHtml(M)}</strong>`+(B?` <span class="light">— ${Craft.escapeHtml(B)}</span>`:"")+(y?`<br><small class="light">${Craft.escapeHtml(y)}</small>`:""),f.addEventListener("click",()=>{v(a.objectID,M,y,j,U)}),i.appendChild(f)}),w()}).catch(()=>{Craft.cp.displayError("Search failed.")}).finally(()=>{p.classList.remove("sdf-loading")})}function v(t,e,n,l="",a=""){o.value=t,I.value=l,x.value=a;const u=[l,a].filter(Boolean).join(" / ");m.innerHTML=Craft.escapeHtml(e)+(u?` <span class="light">— ${Craft.escapeHtml(u)}</span>`:"")+(n?` <span class="light">— ${Craft.escapeHtml(n)}</span>`:"")+` <span class="light">(ID: ${Craft.escapeHtml(t)})</span>`,P.classList.remove("hidden"),p.classList.add("hidden"),h(),r.value="",i.innerHTML=""}b.addEventListener("click",()=>{o.value="",I.value="",x.value="",P.classList.add("hidden"),p.classList.remove("hidden"),m.textContent="",r.focus()}),o.value&&Craft.sendActionRequest("POST","search-index/search/get-document",{data:{indexHandle:D.value,documentId:o.value}}).then(t=>{const{data:e}=t;if(e.success&&e.document){const n=e.document.title||e.document.name||o.value,l=e.document.uri||"",a=e.document.sectionHandle||"",u=e.document.entryTypeHandle||"";v(o.value,n,l,a,u)}else m.textContent=`Document ${o.value} (not found)`}).catch(()=>{m.textContent=`Document ${o.value}`})}})();
