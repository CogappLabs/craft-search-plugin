(()=>{const p=document.querySelectorAll("#search-page .btngroup .btn"),m=document.getElementById("single-mode"),u=document.getElementById("compare-mode");p.forEach(e=>{e.addEventListener("click",function(){for(const r of p)r.classList.remove("active");this.classList.add("active"),this.dataset.mode==="single"?(m.style.display="",u.style.display="none"):(m.style.display="none",u.style.display="")})});const o=document.getElementById("single-search-btn");o.addEventListener("click",()=>{const e=document.getElementById("single-index").value,r=document.getElementById("single-query").value.trim(),s=parseInt(document.getElementById("single-perpage").value,10)||20;if(!r){Craft.cp.displayError("Please enter a search query.");return}o.classList.add("loading"),Craft.sendActionRequest("POST","search-index/search/search",{data:{indexHandle:e,query:r,perPage:s}}).then(t=>{o.classList.remove("loading"),g(t.data)}).catch(()=>{o.classList.remove("loading"),Craft.cp.displayError("Search failed.")})}),document.getElementById("single-query").addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),o.click())});function g(e){const r=document.getElementById("single-results");if(!e.success){r.innerHTML=`<p class="error">${Craft.escapeHtml(e.message||"Search failed.")}</p>`;return}if(!e.hits||e.hits.length===0){r.innerHTML='<p class="zilch">No results found.</p>';return}let s=`<p class="light mb-s">${e.totalHits} results in ${e.processingTimeMs}ms (page ${e.page} of ${e.totalPages})</p>`;s+='<table class="data fullwidth"><thead><tr><th>Title</th><th>URI</th><th>Score</th><th>Object ID</th><th></th></tr></thead><tbody>',e.hits.forEach((t,n)=>{const a=t.title||t.name||"-",l=t.uri||"-",c=t._score!==null&&t._score!==void 0?String(t._score):"-",d=t.objectID||"-";s+=`<tr><td>${Craft.escapeHtml(a)}</td><td>${Craft.escapeHtml(l)}</td><td>${Craft.escapeHtml(c)}</td><td><code>${Craft.escapeHtml(d)}</code></td><td class="thin"><button type="button" class="btn small toggle-raw" data-index="${n}">JSON</button></td></tr><tr class="raw-row" data-index="${n}" style="display:none"><td colspan="5"><pre class="code" style="max-height:200px;overflow:auto;background:var(--gray-050);padding:8px;border-radius:4px">${Craft.escapeHtml(JSON.stringify(t,null,2))}</pre></td></tr>`}),s+="</tbody></table>",e.raw&&(s+=`<details class="mt-s"><summary>Raw engine response</summary><pre class="code" style="max-height:260px;overflow:auto;background:var(--gray-050);padding:8px;border-radius:4px">${Craft.escapeHtml(JSON.stringify(e.raw,null,2))}</pre></details>`),r.innerHTML=s,r.querySelectorAll(".toggle-raw").forEach(t=>{t.addEventListener("click",function(){const n=this.dataset.index,a=r.querySelector(`.raw-row[data-index="${n}"]`);a&&(a.style.display=a.style.display==="none"?"":"none")})})}const i=document.getElementById("compare-search-btn");i.addEventListener("click",()=>{const e=document.querySelectorAll('#compare-indexes input[type="checkbox"]:checked'),r=document.getElementById("compare-query").value.trim(),s=parseInt(document.getElementById("compare-perpage").value,10)||20;if(e.length===0){Craft.cp.displayError("Select at least one index to compare.");return}if(!r){Craft.cp.displayError("Please enter a search query.");return}i.classList.add("loading");const t=document.getElementById("compare-results");t.innerHTML="";let n=e.length;e.forEach(a=>{const l=a.value,c=document.createElement("div");c.style.cssText="flex:1;min-width:300px;max-width:50%",c.innerHTML=`<h3>${Craft.escapeHtml(l)}</h3><p class="spinner"></p>`,t.appendChild(c),Craft.sendActionRequest("POST","search-index/search/search",{data:{indexHandle:l,query:r,perPage:s}}).then(d=>{h(c,l,d.data),n--,n===0&&i.classList.remove("loading")}).catch(()=>{c.innerHTML=`<h3>${Craft.escapeHtml(l)}</h3><p class="error">Search failed.</p>`,n--,n===0&&i.classList.remove("loading")})})}),document.getElementById("compare-query").addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),i.click())});function h(e,r,s){if(!s.success){e.innerHTML=`<h3>${Craft.escapeHtml(r)}</h3><p class="error">${Craft.escapeHtml(s.message||"Failed.")}</p>`;return}let t=`<h3>${Craft.escapeHtml(r)}</h3><p class="light mb-xs">${s.totalHits} results in ${s.processingTimeMs}ms</p>`;!s.hits||s.hits.length===0?t+='<p class="zilch">No results.</p>':(t+='<table class="data fullwidth"><thead><tr><th>Title</th><th>Score</th><th>ID</th></tr></thead><tbody>',s.hits.forEach(n=>{const a=n.title||n.name||"-",l=n._score!==null&&n._score!==void 0?String(n._score):"-";t+=`<tr><td>${Craft.escapeHtml(a)}</td><td>${Craft.escapeHtml(l)}</td><td><code>${Craft.escapeHtml(n.objectID||"-")}</code></td></tr>`}),t+="</tbody></table>"),s.raw&&(t+=`<details class="mt-xs"><summary>Raw engine response</summary><pre class="code" style="max-height:200px;overflow:auto;background:var(--gray-050);padding:8px;border-radius:4px">${Craft.escapeHtml(JSON.stringify(s.raw,null,2))}</pre></details>`),e.innerHTML=t}})();
