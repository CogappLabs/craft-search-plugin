(()=>{const o=document.getElementById("search-page");if(!o)return;const n={searchFailed:o.dataset.tSearchFailed||"Search failed.",noResults:o.dataset.tNoResults||"No results found.",enterQuery:o.dataset.tEnterQuery||"Please enter a search query.",selectIndex:o.dataset.tSelectIndex||"Select at least one index to compare.",resultsSummary:o.dataset.tResultsSummary||"{total} results in {time}ms (page {page} of {pages})",compareSummary:o.dataset.tCompareSummary||"{total} results in {time}ms",noCompareResults:o.dataset.tNoCompareResults||"No results.",rawResponse:o.dataset.tRawResponse||"Raw engine response"},C=document.querySelectorAll("#search-page .btngroup .btn"),u=document.getElementById("single-mode"),h=document.getElementById("compare-mode");u&&h&&C.forEach(e=>{e.addEventListener("click",function(){for(const c of C)c.classList.remove("active");this.classList.add("active"),this.dataset.mode==="single"?(u.classList.remove("hidden"),h.classList.add("hidden")):(u.classList.add("hidden"),h.classList.remove("hidden"))})});const d=document.getElementById("single-search-btn"),H=document.getElementById("single-index"),g=document.getElementById("single-query"),S=document.getElementById("single-perpage"),m=document.getElementById("single-results");d&&H&&g&&S&&(d.addEventListener("click",()=>{const e=H.value,c=g.value.trim(),t=parseInt(S.value,10)||20;if(!c){Craft.cp.displayError(n.enterQuery);return}d.classList.add("loading"),Craft.sendActionRequest("POST","search-index/search/search",{data:{indexHandle:e,query:c,perPage:t}}).then(s=>{d.classList.remove("loading"),b(s.data)}).catch(()=>{d.classList.remove("loading"),Craft.cp.displayError(n.searchFailed)})}),g.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),d.click())}));function b(e){if(!m)return;if(!e.success){m.innerHTML=`<p class="error">${Craft.escapeHtml(e.message||n.searchFailed)}</p>`;return}if(!e.hits||e.hits.length===0){m.innerHTML=`<p class="zilch">${Craft.escapeHtml(n.noResults)}</p>`;return}const c=n.resultsSummary.replace("{total}",String(e.totalHits)).replace("{time}",String(e.processingTimeMs)).replace("{page}",String(e.page)).replace("{pages}",String(e.totalPages));let t=`<p class="light mb-s">${Craft.escapeHtml(c)}</p>`;t+='<table class="data fullwidth"><thead><tr><th>Title</th><th>URI</th><th>Score</th><th>Object ID</th><th></th></tr></thead><tbody>',e.hits.forEach((s,a)=>{const r=s.title||s.name||"-",i=s.uri||"-",l=s._score!==null&&s._score!==void 0?String(s._score):"-",L=s.objectID||"-";t+=`<tr><td>${Craft.escapeHtml(r)}</td><td>${Craft.escapeHtml(i)}</td><td>${Craft.escapeHtml(l)}</td><td><code>${Craft.escapeHtml(L)}</code></td><td class="thin"><button type="button" class="btn small toggle-raw" data-index="${a}">JSON</button></td></tr><tr class="raw-row hidden" data-index="${a}"><td colspan="5"><pre class="code si-code-block si-raw-json">${Craft.escapeHtml(JSON.stringify(s,null,2))}</pre></td></tr>`}),t+="</tbody></table>",e.raw&&(t+=`<details class="mt-s"><summary>${Craft.escapeHtml(n.rawResponse)}</summary><pre class="code si-code-block si-raw-response">${Craft.escapeHtml(JSON.stringify(e.raw,null,2))}</pre></details>`),m.innerHTML=t,m.querySelectorAll(".toggle-raw").forEach(s=>{s.addEventListener("click",function(){const a=this.dataset.index;if(!a)return;const r=m.querySelector(`.raw-row[data-index="${a}"]`);r&&r.classList.toggle("hidden")})})}const p=document.getElementById("compare-search-btn"),f=document.getElementById("compare-query"),E=document.getElementById("compare-perpage"),y=document.getElementById("compare-results");p&&f&&E&&(p.addEventListener("click",()=>{const e=document.querySelectorAll('#compare-indexes input[type="checkbox"]:checked'),c=f.value.trim(),t=parseInt(E.value,10)||20;if(e.length===0){Craft.cp.displayError(n.selectIndex);return}if(!c){Craft.cp.displayError(n.enterQuery);return}if(!y)return;p.classList.add("loading"),y.innerHTML="";const s=[];e.forEach(r=>{const i=r.value,l=document.createElement("div");l.className="si-compare-panel",l.innerHTML=`<h3>${Craft.escapeHtml(i)}</h3><p class="spinner"></p>`,y.appendChild(l),s.push({handle:i,panel:l})});const a=s.map(({handle:r,panel:i})=>Craft.sendActionRequest("POST","search-index/search/search",{data:{indexHandle:r,query:c,perPage:t}}).then(l=>{I(i,r,l.data)}).catch(()=>{i.innerHTML=`<h3>${Craft.escapeHtml(r)}</h3><p class="error">${Craft.escapeHtml(n.searchFailed)}</p>`}));Promise.allSettled(a).then(()=>{p.classList.remove("loading")})}),f.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),p.click())}));function I(e,c,t){if(!t.success){e.innerHTML=`<h3>${Craft.escapeHtml(c)}</h3><p class="error">${Craft.escapeHtml(t.message||n.searchFailed)}</p>`;return}const s=n.compareSummary.replace("{total}",String(t.totalHits)).replace("{time}",String(t.processingTimeMs));let a=`<h3>${Craft.escapeHtml(c)}</h3><p class="light mb-xs">${Craft.escapeHtml(s)}</p>`;!t.hits||t.hits.length===0?a+=`<p class="zilch">${Craft.escapeHtml(n.noCompareResults)}</p>`:(a+='<table class="data fullwidth"><thead><tr><th>Title</th><th>Score</th><th>ID</th></tr></thead><tbody>',t.hits.forEach(r=>{const i=r.title||r.name||"-",l=r._score!==null&&r._score!==void 0?String(r._score):"-";a+=`<tr><td>${Craft.escapeHtml(i)}</td><td>${Craft.escapeHtml(l)}</td><td><code>${Craft.escapeHtml(r.objectID||"-")}</code></td></tr>`}),a+="</tbody></table>"),t.raw&&(a+=`<details class="mt-xs"><summary>${Craft.escapeHtml(n.rawResponse)}</summary><pre class="code si-code-block si-raw-json">${Craft.escapeHtml(JSON.stringify(t.raw,null,2))}</pre></details>`),e.innerHTML=a}})();
