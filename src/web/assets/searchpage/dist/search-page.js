(()=>{const g=document.querySelectorAll("#search-page .btngroup .btn"),m=document.getElementById("single-mode"),p=document.getElementById("compare-mode");m&&p&&g.forEach(e=>{e.addEventListener("click",function(){for(const r of g)r.classList.remove("active");this.classList.add("active"),this.dataset.mode==="single"?(m.classList.remove("hidden"),p.classList.add("hidden")):(m.classList.add("hidden"),p.classList.remove("hidden"))})});const o=document.getElementById("single-search-btn"),y=document.getElementById("single-index"),u=document.getElementById("single-query"),E=document.getElementById("single-perpage"),i=document.getElementById("single-results");o&&y&&u&&E&&(o.addEventListener("click",()=>{const e=y.value,r=u.value.trim(),t=parseInt(E.value,10)||20;if(!r){Craft.cp.displayError("Please enter a search query.");return}o.classList.add("loading"),Craft.sendActionRequest("POST","search-index/search/search",{data:{indexHandle:e,query:r,perPage:t}}).then(s=>{o.classList.remove("loading"),H(s.data)}).catch(()=>{o.classList.remove("loading"),Craft.cp.displayError("Search failed.")})}),u.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),o.click())}));function H(e){if(!i)return;if(!e.success){i.innerHTML=`<p class="error">${Craft.escapeHtml(e.message||"Search failed.")}</p>`;return}if(!e.hits||e.hits.length===0){i.innerHTML='<p class="zilch">No results found.</p>';return}let r=`<p class="light mb-s">${e.totalHits} results in ${e.processingTimeMs}ms (page ${e.page} of ${e.totalPages})</p>`;r+='<table class="data fullwidth"><thead><tr><th>Title</th><th>URI</th><th>Score</th><th>Object ID</th><th></th></tr></thead><tbody>',e.hits.forEach((t,s)=>{const n=t.title||t.name||"-",c=t.uri||"-",a=t._score!==null&&t._score!==void 0?String(t._score):"-",l=t.objectID||"-";r+=`<tr><td>${Craft.escapeHtml(n)}</td><td>${Craft.escapeHtml(c)}</td><td>${Craft.escapeHtml(a)}</td><td><code>${Craft.escapeHtml(l)}</code></td><td class="thin"><button type="button" class="btn small toggle-raw" data-index="${s}">JSON</button></td></tr><tr class="raw-row hidden" data-index="${s}"><td colspan="5"><pre class="code si-code-block si-raw-json">${Craft.escapeHtml(JSON.stringify(t,null,2))}</pre></td></tr>`}),r+="</tbody></table>",e.raw&&(r+=`<details class="mt-s"><summary>Raw engine response</summary><pre class="code si-code-block si-raw-response">${Craft.escapeHtml(JSON.stringify(e.raw,null,2))}</pre></details>`),i.innerHTML=r,i.querySelectorAll(".toggle-raw").forEach(t=>{t.addEventListener("click",function(){const s=this.dataset.index;if(!s)return;const n=i.querySelector(`.raw-row[data-index="${s}"]`);n&&n.classList.toggle("hidden")})})}const d=document.getElementById("compare-search-btn"),h=document.getElementById("compare-query"),b=document.getElementById("compare-perpage"),f=document.getElementById("compare-results");d&&h&&b&&(d.addEventListener("click",()=>{const e=document.querySelectorAll('#compare-indexes input[type="checkbox"]:checked'),r=h.value.trim(),t=parseInt(b.value,10)||20;if(e.length===0){Craft.cp.displayError("Select at least one index to compare.");return}if(!r){Craft.cp.displayError("Please enter a search query.");return}if(!f)return;d.classList.add("loading"),f.innerHTML="";const s=[];e.forEach(c=>{const a=c.value,l=document.createElement("div");l.className="si-compare-panel",l.innerHTML=`<h3>${Craft.escapeHtml(a)}</h3><p class="spinner"></p>`,f.appendChild(l),s.push({handle:a,panel:l})});const n=s.map(({handle:c,panel:a})=>Craft.sendActionRequest("POST","search-index/search/search",{data:{indexHandle:c,query:r,perPage:t}}).then(l=>{C(a,c,l.data)}).catch(()=>{a.innerHTML=`<h3>${Craft.escapeHtml(c)}</h3><p class="error">Search failed.</p>`}));Promise.allSettled(n).then(()=>{d.classList.remove("loading")})}),h.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),d.click())}));function C(e,r,t){if(!t.success){e.innerHTML=`<h3>${Craft.escapeHtml(r)}</h3><p class="error">${Craft.escapeHtml(t.message||"Failed.")}</p>`;return}let s=`<h3>${Craft.escapeHtml(r)}</h3><p class="light mb-xs">${t.totalHits} results in ${t.processingTimeMs}ms</p>`;!t.hits||t.hits.length===0?s+='<p class="zilch">No results.</p>':(s+='<table class="data fullwidth"><thead><tr><th>Title</th><th>Score</th><th>ID</th></tr></thead><tbody>',t.hits.forEach(n=>{const c=n.title||n.name||"-",a=n._score!==null&&n._score!==void 0?String(n._score):"-";s+=`<tr><td>${Craft.escapeHtml(c)}</td><td>${Craft.escapeHtml(a)}</td><td><code>${Craft.escapeHtml(n.objectID||"-")}</code></td></tr>`}),s+="</tbody></table>"),t.raw&&(s+=`<details class="mt-xs"><summary>Raw engine response</summary><pre class="code si-code-block si-raw-json">${Craft.escapeHtml(JSON.stringify(t.raw,null,2))}</pre></details>`),e.innerHTML=s}})();
