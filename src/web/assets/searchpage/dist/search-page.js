(()=>{const o=document.getElementById("search-page");if(!o)return;const l={searchFailed:o.dataset.tSearchFailed||"Search failed.",noResults:o.dataset.tNoResults||"No results found.",enterQuery:o.dataset.tEnterQuery||"Please enter a search query.",selectIndex:o.dataset.tSelectIndex||"Select at least one index to compare.",resultsSummary:o.dataset.tResultsSummary||"{total} results in {time}ms (page {page} of {pages})",compareSummary:o.dataset.tCompareSummary||"{total} results in {time}ms",noCompareResults:o.dataset.tNoCompareResults||"No results.",rawResponse:o.dataset.tRawResponse||"Raw engine response"},C=document.querySelectorAll("#search-page .btngroup .btn"),f=document.getElementById("single-mode"),y=document.getElementById("compare-mode");f&&y&&C.forEach(e=>{e.addEventListener("click",function(){for(const r of C)r.classList.remove("active");this.classList.add("active"),this.dataset.mode==="single"?(f.classList.remove("hidden"),y.classList.add("hidden")):(f.classList.add("hidden"),y.classList.remove("hidden"))})});const H=JSON.parse(o.dataset.embeddingFields||"{}"),p=document.getElementById("single-search-btn"),d=document.getElementById("single-index"),E=document.getElementById("single-query"),v=document.getElementById("single-perpage"),u=document.getElementById("single-results"),I=document.getElementById("single-search-mode-field"),m=document.getElementById("single-search-mode"),L=document.getElementById("single-embedding-field-field"),h=document.getElementById("single-embedding-field");function x(){if(!d||!I||!m)return;const e=d.value,r=H[e]||[],t=r.length>0;I.classList.toggle("hidden",!t),t||(m.value="text"),$(r)}function $(e){if(!d||!m||!L||!h)return;const r=d.value,t=e??H[r]??[],a=m.value!=="text"&&t.length>1;L.classList.toggle("hidden",!a),h.innerHTML="";for(const s of t){const c=document.createElement("option");c.value=s,c.textContent=s,h.appendChild(c)}}d&&(d.addEventListener("change",()=>x()),x()),m&&m.addEventListener("change",()=>$()),p&&d&&E&&v&&(p.addEventListener("click",()=>{const e=d.value,r=E.value.trim(),t=parseInt(v.value,10)||20,n=m?.value||"text",a=h?.value||"";if(!r){Craft.cp.displayError(l.enterQuery);return}p.classList.add("loading");const s={indexHandle:e,query:r,perPage:t};n!=="text"&&(s.searchMode=n,a&&(s.embeddingField=a)),Craft.sendActionRequest("POST","search-index/search/search",{data:s}).then(c=>{p.classList.remove("loading"),B(c.data)}).catch(()=>{p.classList.remove("loading"),Craft.cp.displayError(l.searchFailed)})}),E.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),p.click())}));function B(e){if(!u)return;if(!e.success){u.innerHTML=`<p class="error">${Craft.escapeHtml(e.message||l.searchFailed)}</p>`;return}if(!e.hits||e.hits.length===0){u.innerHTML=`<p class="zilch">${Craft.escapeHtml(l.noResults)}</p>`;return}const r=l.resultsSummary.replace("{total}",String(e.totalHits)).replace("{time}",String(e.processingTimeMs)).replace("{page}",String(e.page)).replace("{pages}",String(e.totalPages));let t=`<p class="light mb-s">${Craft.escapeHtml(r)}</p>`;t+='<table class="data fullwidth"><thead><tr><th>Title</th><th>URI</th><th>Score</th><th>Object ID</th><th></th></tr></thead><tbody>',e.hits.forEach((n,a)=>{const s=n.title||n.name||"-",c=n.uri||"-",i=n._score!==null&&n._score!==void 0?String(n._score):"-",M=n.objectID||"-";t+=`<tr><td>${Craft.escapeHtml(s)}</td><td>${Craft.escapeHtml(c)}</td><td>${Craft.escapeHtml(i)}</td><td><code>${Craft.escapeHtml(M)}</code></td><td class="thin"><button type="button" class="btn small toggle-raw" data-index="${a}">JSON</button></td></tr><tr class="raw-row hidden" data-index="${a}"><td colspan="5"><pre class="code si-code-block si-raw-json">${Craft.escapeHtml(JSON.stringify(n,null,2))}</pre></td></tr>`}),t+="</tbody></table>",e.raw&&(t+=`<details class="mt-s"><summary>${Craft.escapeHtml(l.rawResponse)}</summary><pre class="code si-code-block si-raw-response">${Craft.escapeHtml(JSON.stringify(e.raw,null,2))}</pre></details>`),u.innerHTML=t,u.querySelectorAll(".toggle-raw").forEach(n=>{n.addEventListener("click",function(){const a=this.dataset.index;if(!a)return;const s=u.querySelector(`.raw-row[data-index="${a}"]`);s&&s.classList.toggle("hidden")})})}const g=document.getElementById("compare-search-btn"),b=document.getElementById("compare-query"),w=document.getElementById("compare-perpage"),S=document.getElementById("compare-results");g&&b&&w&&(g.addEventListener("click",()=>{const e=document.querySelectorAll('#compare-indexes input[type="checkbox"]:checked'),r=b.value.trim(),t=parseInt(w.value,10)||20;if(e.length===0){Craft.cp.displayError(l.selectIndex);return}if(!r){Craft.cp.displayError(l.enterQuery);return}if(!S)return;g.classList.add("loading"),S.innerHTML="";const n=[];e.forEach(s=>{const c=s.value,i=document.createElement("div");i.className="si-compare-panel",i.innerHTML=`<h3>${Craft.escapeHtml(c)}</h3><p class="spinner"></p>`,S.appendChild(i),n.push({handle:c,panel:i})});const a=n.map(({handle:s,panel:c})=>Craft.sendActionRequest("POST","search-index/search/search",{data:{indexHandle:s,query:r,perPage:t}}).then(i=>{R(c,s,i.data)}).catch(()=>{c.innerHTML=`<h3>${Craft.escapeHtml(s)}</h3><p class="error">${Craft.escapeHtml(l.searchFailed)}</p>`}));Promise.allSettled(a).then(()=>{g.classList.remove("loading")})}),b.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),g.click())}));function R(e,r,t){if(!t.success){e.innerHTML=`<h3>${Craft.escapeHtml(r)}</h3><p class="error">${Craft.escapeHtml(t.message||l.searchFailed)}</p>`;return}const n=l.compareSummary.replace("{total}",String(t.totalHits)).replace("{time}",String(t.processingTimeMs));let a=`<h3>${Craft.escapeHtml(r)}</h3><p class="light mb-xs">${Craft.escapeHtml(n)}</p>`;!t.hits||t.hits.length===0?a+=`<p class="zilch">${Craft.escapeHtml(l.noCompareResults)}</p>`:(a+='<table class="data fullwidth"><thead><tr><th>Title</th><th>Score</th><th>ID</th></tr></thead><tbody>',t.hits.forEach(s=>{const c=s.title||s.name||"-",i=s._score!==null&&s._score!==void 0?String(s._score):"-";a+=`<tr><td>${Craft.escapeHtml(c)}</td><td>${Craft.escapeHtml(i)}</td><td><code>${Craft.escapeHtml(s.objectID||"-")}</code></td></tr>`}),a+="</tbody></table>"),t.raw&&(a+=`<details class="mt-xs"><summary>${Craft.escapeHtml(l.rawResponse)}</summary><pre class="code si-code-block si-raw-json">${Craft.escapeHtml(JSON.stringify(t.raw,null,2))}</pre></details>`),e.innerHTML=a}})();
