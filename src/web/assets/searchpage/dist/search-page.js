(()=>{const f=document.querySelectorAll("#search-page .btngroup .btn"),p=document.getElementById("single-mode"),m=document.getElementById("compare-mode");p&&m&&f.forEach(e=>{e.addEventListener("click",function(){for(const r of f)r.classList.remove("active");this.classList.add("active"),this.dataset.mode==="single"?(p.style.display="",m.style.display="none"):(p.style.display="none",m.style.display="")})});const o=document.getElementById("single-search-btn"),y=document.getElementById("single-index"),u=document.getElementById("single-query"),x=document.getElementById("single-perpage"),i=document.getElementById("single-results");o&&y&&u&&x&&(o.addEventListener("click",()=>{const e=y.value,r=u.value.trim(),t=parseInt(x.value,10)||20;if(!r){Craft.cp.displayError("Please enter a search query.");return}o.classList.add("loading"),Craft.sendActionRequest("POST","search-index/search/search",{data:{indexHandle:e,query:r,perPage:t}}).then(s=>{o.classList.remove("loading"),v(s.data)}).catch(()=>{o.classList.remove("loading"),Craft.cp.displayError("Search failed.")})}),u.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),o.click())}));function v(e){if(!i)return;if(!e.success){i.innerHTML=`<p class="error">${Craft.escapeHtml(e.message||"Search failed.")}</p>`;return}if(!e.hits||e.hits.length===0){i.innerHTML='<p class="zilch">No results found.</p>';return}let r=`<p class="light mb-s">${e.totalHits} results in ${e.processingTimeMs}ms (page ${e.page} of ${e.totalPages})</p>`;r+='<table class="data fullwidth"><thead><tr><th>Title</th><th>URI</th><th>Score</th><th>Object ID</th><th></th></tr></thead><tbody>',e.hits.forEach((t,s)=>{const n=t.title||t.name||"-",a=t.uri||"-",l=t._score!==null&&t._score!==void 0?String(t._score):"-",c=t.objectID||"-";r+=`<tr><td>${Craft.escapeHtml(n)}</td><td>${Craft.escapeHtml(a)}</td><td>${Craft.escapeHtml(l)}</td><td><code>${Craft.escapeHtml(c)}</code></td><td class="thin"><button type="button" class="btn small toggle-raw" data-index="${s}">JSON</button></td></tr><tr class="raw-row" data-index="${s}" style="display:none"><td colspan="5"><pre class="code" style="max-height:200px;overflow:auto;background:var(--gray-050);padding:8px;border-radius:4px">${Craft.escapeHtml(JSON.stringify(t,null,2))}</pre></td></tr>`}),r+="</tbody></table>",e.raw&&(r+=`<details class="mt-s"><summary>Raw engine response</summary><pre class="code" style="max-height:260px;overflow:auto;background:var(--gray-050);padding:8px;border-radius:4px">${Craft.escapeHtml(JSON.stringify(e.raw,null,2))}</pre></details>`),i.innerHTML=r,i.querySelectorAll(".toggle-raw").forEach(t=>{t.addEventListener("click",function(){const s=this.dataset.index;if(!s)return;const n=i.querySelector(`.raw-row[data-index="${s}"]`);n&&(n.style.display=n.style.display==="none"?"":"none")})})}const d=document.getElementById("compare-search-btn"),h=document.getElementById("compare-query"),b=document.getElementById("compare-perpage"),g=document.getElementById("compare-results");d&&h&&b&&(d.addEventListener("click",()=>{const e=document.querySelectorAll('#compare-indexes input[type="checkbox"]:checked'),r=h.value.trim(),t=parseInt(b.value,10)||20;if(e.length===0){Craft.cp.displayError("Select at least one index to compare.");return}if(!r){Craft.cp.displayError("Please enter a search query.");return}if(!g)return;d.classList.add("loading"),g.innerHTML="";const s=[];e.forEach(a=>{const l=a.value,c=document.createElement("div");c.style.cssText="flex:1;min-width:300px;max-width:50%",c.innerHTML=`<h3>${Craft.escapeHtml(l)}</h3><p class="spinner"></p>`,g.appendChild(c),s.push({handle:l,panel:c})});const n=s.map(({handle:a,panel:l})=>Craft.sendActionRequest("POST","search-index/search/search",{data:{indexHandle:a,query:r,perPage:t}}).then(c=>{E(l,a,c.data)}).catch(()=>{l.innerHTML=`<h3>${Craft.escapeHtml(a)}</h3><p class="error">Search failed.</p>`}));Promise.allSettled(n).then(()=>{d.classList.remove("loading")})}),h.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),d.click())}));function E(e,r,t){if(!t.success){e.innerHTML=`<h3>${Craft.escapeHtml(r)}</h3><p class="error">${Craft.escapeHtml(t.message||"Failed.")}</p>`;return}let s=`<h3>${Craft.escapeHtml(r)}</h3><p class="light mb-xs">${t.totalHits} results in ${t.processingTimeMs}ms</p>`;!t.hits||t.hits.length===0?s+='<p class="zilch">No results.</p>':(s+='<table class="data fullwidth"><thead><tr><th>Title</th><th>Score</th><th>ID</th></tr></thead><tbody>',t.hits.forEach(n=>{const a=n.title||n.name||"-",l=n._score!==null&&n._score!==void 0?String(n._score):"-";s+=`<tr><td>${Craft.escapeHtml(a)}</td><td>${Craft.escapeHtml(l)}</td><td><code>${Craft.escapeHtml(n.objectID||"-")}</code></td></tr>`}),s+="</tbody></table>"),t.raw&&(s+=`<details class="mt-xs"><summary>Raw engine response</summary><pre class="code" style="max-height:200px;overflow:auto;background:var(--gray-050);padding:8px;border-radius:4px">${Craft.escapeHtml(JSON.stringify(t.raw,null,2))}</pre></details>`),e.innerHTML=s}})();
